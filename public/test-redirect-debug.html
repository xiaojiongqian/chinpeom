<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Redirectè®¤è¯è¯¦ç»†è°ƒè¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
        }
        .success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .info {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        .warning {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .json-display {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .log-item {
            margin: 5px 0;
            padding: 5px;
            border-left: 3px solid #007bff;
            background-color: #f8f9fa;
        }
    </style>
</head>
<body>
    <h1>ğŸ” Redirectè®¤è¯è¯¦ç»†è°ƒè¯•</h1>
    
    <div class="warning">
        <strong>è°ƒè¯•ç›®æ ‡:</strong> è¯¦ç»†åˆ†æredirectè®¤è¯æµç¨‹çš„æ¯ä¸€æ­¥ï¼Œæ‰¾å‡ºé—®é¢˜æ‰€åœ¨
    </div>

    <div id="status" class="status info">é¡µé¢åŠ è½½ä¸­ï¼Œæ­£åœ¨æ£€æŸ¥ç¯å¢ƒ...</div>

    <h3>ğŸ“Š å½“å‰çŠ¶æ€</h3>
    <div id="currentState" class="json-display"></div>

    <h3>ğŸ”„ æ“ä½œæ§åˆ¶</h3>
    <button onclick="startRedirectAuth()">ğŸš€ å¯åŠ¨Redirectè®¤è¯</button>
    <button onclick="manualCheckRedirect()">ğŸ” æ‰‹åŠ¨æ£€æŸ¥Redirectç»“æœ</button>
    <button onclick="clearAllAuth()">ğŸ§¹ æ¸…é™¤æ‰€æœ‰è®¤è¯çŠ¶æ€</button>
    <button onclick="refreshPage()">ğŸ”„ åˆ·æ–°é¡µé¢</button>

    <h3>ğŸ“ è¯¦ç»†æ—¥å¿—</h3>
    <div id="logs" class="json-display"></div>

    <h3>ğŸ”§ è®¤è¯ç»“æœ</h3>
    <div id="authResult" class="json-display"></div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js'
        import { 
            getAuth, 
            GoogleAuthProvider, 
            signInWithRedirect,
            getRedirectResult,
            signOut,
            onAuthStateChanged
        } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js'

        // Firebaseé…ç½®
        const firebaseConfig = {
            apiKey: "AIzaSyCHt0r0EgWVt7xhOZS_piykzBcTSjKexek",
            authDomain: "poem2guess-8d19f.firebaseapp.com",
            projectId: "poem2guess-8d19f",
            storageBucket: "poem2guess-8d19f.firebasestorage.app",
            messagingSenderId: "521053998371",
            appId: "1:521053998371:web:5a8c5e7b8ec4d8f75f5e5d"
        }

        // åˆå§‹åŒ–Firebase
        const app = initializeApp(firebaseConfig)
        const auth = getAuth(app)
        const googleProvider = new GoogleAuthProvider()

        // æ—¥å¿—ç³»ç»Ÿ
        const logs = []
        let authResult = null

        function addLog(message, type = 'info', data = null) {
            const timestamp = new Date().toLocaleTimeString()
            const logEntry = {
                æ—¶é—´: timestamp,
                æ¶ˆæ¯: message,
                ç±»å‹: type,
                æ•°æ®: data
            }
            logs.push(logEntry)
            updateLogs()
            console.log(`[${type.toUpperCase()}] ${message}`, data)
        }

        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status')
            statusDiv.className = `status ${type}`
            statusDiv.textContent = message
            addLog(`çŠ¶æ€æ›´æ–°: ${message}`, type)
        }

        function updateCurrentState() {
            const state = {
                å½“å‰URL: window.location.href,
                URLå‚æ•°: Object.fromEntries(new URLSearchParams(window.location.search)),
                URLå“ˆå¸Œ: window.location.hash,
                Firebaseç”¨æˆ·: auth.currentUser ? {
                    uid: auth.currentUser.uid,
                    email: auth.currentUser.email,
                    displayName: auth.currentUser.displayName
                } : null,
                é¡µé¢åŠ è½½æ—¶é—´: new Date().toLocaleString(),
                æµè§ˆå™¨: navigator.userAgent.substring(0, 50) + '...',
                æ˜¯å¦HTTPS: window.location.protocol === 'https:',
                åŸŸå: window.location.hostname
            }
            
            document.getElementById('currentState').textContent = JSON.stringify(state, null, 2)
            return state
        }

        function updateLogs() {
            document.getElementById('logs').textContent = JSON.stringify(logs.slice(-10), null, 2)
        }

        function updateAuthResult() {
            document.getElementById('authResult').textContent = JSON.stringify(authResult, null, 2)
        }

        // å¯åŠ¨Redirectè®¤è¯
        window.startRedirectAuth = async function() {
            try {
                addLog('å¼€å§‹å¯åŠ¨Redirectè®¤è¯', 'info')
                updateStatus('ğŸš€ æ­£åœ¨å¯åŠ¨Redirectè®¤è¯...', 'info')
                
                // ä¿å­˜çŠ¶æ€æ ‡è®°
                localStorage.setItem('redirect_auth_started', 'true')
                localStorage.setItem('redirect_start_time', Date.now().toString())
                
                addLog('è®¾ç½®æœ¬åœ°å­˜å‚¨æ ‡è®°', 'info', {
                    redirect_auth_started: 'true',
                    redirect_start_time: Date.now()
                })
                
                await signInWithRedirect(auth, googleProvider)
                
                // è¿™è¡Œä»£ç é€šå¸¸ä¸ä¼šæ‰§è¡Œï¼Œå› ä¸ºé¡µé¢ä¼šè·³è½¬
                addLog('signInWithRedirect è°ƒç”¨å®Œæˆï¼ˆé¡µé¢åº”è¯¥å·²è·³è½¬ï¼‰', 'warning')
                
            } catch (error) {
                addLog('å¯åŠ¨Redirectè®¤è¯å¤±è´¥', 'error', error)
                updateStatus(`âŒ å¯åŠ¨Redirectè®¤è¯å¤±è´¥: ${error.message}`, 'error')
            }
        }

        // æ‰‹åŠ¨æ£€æŸ¥Redirectç»“æœ
        window.manualCheckRedirect = async function() {
            try {
                addLog('å¼€å§‹æ‰‹åŠ¨æ£€æŸ¥Redirectç»“æœ', 'info')
                updateStatus('ğŸ” æ­£åœ¨æ£€æŸ¥Redirectç»“æœ...', 'info')
                
                const result = await getRedirectResult(auth)
                
                addLog('getRedirectResult è°ƒç”¨å®Œæˆ', 'info', {
                    hasResult: !!result,
                    result: result ? {
                        user: {
                            uid: result.user.uid,
                            email: result.user.email,
                            displayName: result.user.displayName
                        },
                        operationType: result.operationType
                    } : null
                })
                
                if (result) {
                    addLog('æ£€æµ‹åˆ°Redirectè®¤è¯ç»“æœï¼', 'success')
                    updateStatus('âœ… æ£€æµ‹åˆ°Redirectè®¤è¯ç»“æœï¼', 'success')
                    
                    const user = result.user
                    const idToken = await user.getIdToken()
                    
                    authResult = {
                        è®¤è¯æ–¹å¼: 'Redirect',
                        ç”¨æˆ·ä¿¡æ¯: {
                            uid: user.uid,
                            email: user.email,
                            displayName: user.displayName,
                            photoURL: user.photoURL,
                            emailVerified: user.emailVerified
                        },
                        Tokenä¿¡æ¯: {
                            idToken: idToken.substring(0, 50) + '...',
                            tokenLength: idToken.length
                        },
                        æ“ä½œç±»å‹: result.operationType,
                        æ—¶é—´: new Date().toLocaleString()
                    }
                    
                    updateAuthResult()
                    
                    // æ¸…é™¤æœ¬åœ°å­˜å‚¨æ ‡è®°
                    localStorage.removeItem('redirect_auth_started')
                    localStorage.removeItem('redirect_start_time')
                    
                    addLog('Redirectè®¤è¯å®Œæˆï¼Œæ¸…é™¤æœ¬åœ°å­˜å‚¨æ ‡è®°', 'success')
                    
                    // æµ‹è¯•åç«¯éªŒè¯
                    await testBackendAuth(idToken, user.uid)
                    
                } else {
                    addLog('æ²¡æœ‰æ£€æµ‹åˆ°Redirectè®¤è¯ç»“æœ', 'warning')
                    updateStatus('â„¹ï¸ æ²¡æœ‰æ£€æµ‹åˆ°Redirectè®¤è¯ç»“æœ', 'info')
                    
                    // æ£€æŸ¥æ˜¯å¦æœ‰å¯åŠ¨æ ‡è®°
                    const startFlag = localStorage.getItem('redirect_auth_started')
                    const startTime = localStorage.getItem('redirect_start_time')
                    
                    if (startFlag) {
                        const elapsed = Date.now() - parseInt(startTime)
                        addLog('å‘ç°æœªå®Œæˆçš„Redirectè®¤è¯', 'warning', {
                            ç»è¿‡æ—¶é—´: `${Math.round(elapsed / 1000)}ç§’`,
                            å¼€å§‹æ—¶é—´: new Date(parseInt(startTime)).toLocaleString()
                        })
                        
                        if (elapsed > 300000) { // 5åˆ†é’Ÿ
                            addLog('Redirectè®¤è¯å¯èƒ½å·²è¶…æ—¶ï¼Œæ¸…é™¤æ ‡è®°', 'warning')
                            localStorage.removeItem('redirect_auth_started')
                            localStorage.removeItem('redirect_start_time')
                        }
                    }
                }
                
            } catch (error) {
                addLog('æ£€æŸ¥Redirectç»“æœå¤±è´¥', 'error', error)
                updateStatus(`âŒ æ£€æŸ¥Redirectç»“æœå¤±è´¥: ${error.message}`, 'error')
            }
        }

        // æµ‹è¯•åç«¯è®¤è¯
        async function testBackendAuth(idToken, firebaseUid) {
            try {
                addLog('å¼€å§‹æµ‹è¯•åç«¯è®¤è¯', 'info')
                
                const response = await fetch('http://localhost:3001/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        provider: 'google',
                        access_token: idToken,
                        firebase_uid: firebaseUid
                    })
                })

                const data = await response.json()
                
                if (response.ok) {
                    addLog('åç«¯è®¤è¯æˆåŠŸï¼', 'success', data)
                    updateStatus('ğŸ‰ Redirectè®¤è¯ + åç«¯éªŒè¯å…¨éƒ¨æˆåŠŸï¼', 'success')
                    
                    authResult.åç«¯éªŒè¯ = {
                        çŠ¶æ€: 'æˆåŠŸ',
                        å“åº”: data
                    }
                    updateAuthResult()
                    
                } else {
                    addLog('åç«¯è®¤è¯å¤±è´¥', 'error', data)
                    updateStatus(`âŒ Redirectè®¤è¯æˆåŠŸï¼Œä½†åç«¯éªŒè¯å¤±è´¥: ${data.message}`, 'error')
                    
                    authResult.åç«¯éªŒè¯ = {
                        çŠ¶æ€: 'å¤±è´¥',
                        å“åº”: data
                    }
                    updateAuthResult()
                }
                
            } catch (error) {
                addLog('åç«¯è®¤è¯æµ‹è¯•å¤±è´¥', 'error', error)
                updateStatus(`âŒ åç«¯è®¤è¯æµ‹è¯•å¤±è´¥: ${error.message}`, 'error')
            }
        }

        // æ¸…é™¤æ‰€æœ‰è®¤è¯çŠ¶æ€
        window.clearAllAuth = async function() {
            try {
                addLog('å¼€å§‹æ¸…é™¤æ‰€æœ‰è®¤è¯çŠ¶æ€', 'info')
                
                await signOut(auth)
                localStorage.removeItem('redirect_auth_started')
                localStorage.removeItem('redirect_start_time')
                authResult = null
                
                updateAuthResult()
                updateCurrentState()
                
                addLog('æ‰€æœ‰è®¤è¯çŠ¶æ€å·²æ¸…é™¤', 'success')
                updateStatus('ğŸ§¹ æ‰€æœ‰è®¤è¯çŠ¶æ€å·²æ¸…é™¤', 'success')
                
            } catch (error) {
                addLog('æ¸…é™¤è®¤è¯çŠ¶æ€å¤±è´¥', 'error', error)
                updateStatus(`âŒ æ¸…é™¤è®¤è¯çŠ¶æ€å¤±è´¥: ${error.message}`, 'error')
            }
        }

        // åˆ·æ–°é¡µé¢
        window.refreshPage = function() {
            addLog('æ‰‹åŠ¨åˆ·æ–°é¡µé¢', 'info')
            window.location.reload()
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥
        window.addEventListener('load', async () => {
            addLog('é¡µé¢åŠ è½½å®Œæˆ', 'info')
            updateStatus('ğŸ“± é¡µé¢å·²åŠ è½½ï¼Œå¼€å§‹ç¯å¢ƒæ£€æŸ¥...', 'info')
            
            // æ›´æ–°å½“å‰çŠ¶æ€
            const state = updateCurrentState()
            addLog('å½“å‰é¡µé¢çŠ¶æ€', 'info', state)
            
            // æ£€æŸ¥æ˜¯å¦æ¥è‡ªredirect
            const startFlag = localStorage.getItem('redirect_auth_started')
            if (startFlag) {
                addLog('æ£€æµ‹åˆ°Redirectè®¤è¯æ ‡è®°ï¼Œå¯èƒ½æ¥è‡ªGoogleè®¤è¯é¡µé¢', 'info')
                updateStatus('ğŸ” æ£€æµ‹åˆ°Redirectæ ‡è®°ï¼Œæ­£åœ¨æ£€æŸ¥è®¤è¯ç»“æœ...', 'info')
                
                // å»¶è¿Ÿæ£€æŸ¥ï¼Œç»™Firebaseæ—¶é—´å¤„ç†
                setTimeout(async () => {
                    await manualCheckRedirect()
                }, 1000)
            } else {
                addLog('æ²¡æœ‰æ£€æµ‹åˆ°Redirectè®¤è¯æ ‡è®°', 'info')
                updateStatus('âœ… é¡µé¢åŠ è½½å®Œæˆï¼Œå‡†å¤‡è¿›è¡ŒRedirectè®¤è¯æµ‹è¯•', 'success')
            }
        })

        // ç›‘å¬è®¤è¯çŠ¶æ€å˜åŒ–
        onAuthStateChanged(auth, (user) => {
            if (user) {
                addLog('Firebaseè®¤è¯çŠ¶æ€å˜åŒ–ï¼šå·²ç™»å½•', 'info', {
                    uid: user.uid,
                    email: user.email,
                    displayName: user.displayName
                })
            } else {
                addLog('Firebaseè®¤è¯çŠ¶æ€å˜åŒ–ï¼šæœªç™»å½•', 'info')
            }
            updateCurrentState()
        })

        // ç›‘å¬é¡µé¢å¯è§æ€§å˜åŒ–
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                addLog('é¡µé¢é‡æ–°å¯è§ï¼Œå¯èƒ½ä»è®¤è¯é¡µé¢è¿”å›', 'info')
                // å»¶è¿Ÿæ£€æŸ¥redirectç»“æœ
                setTimeout(manualCheckRedirect, 500)
            }
        })
    </script>

    <div class="info">
        <h3>ğŸ“‹ è°ƒè¯•è¯´æ˜:</h3>
        <ol>
            <li><strong>æ­£å¸¸æµç¨‹</strong>: ç‚¹å‡»"å¯åŠ¨Redirectè®¤è¯" â†’ è·³è½¬Google â†’ è®¤è¯å®Œæˆ â†’ è‡ªåŠ¨è¿”å›å¹¶æ£€æµ‹ç»“æœ</li>
            <li><strong>æ‰‹åŠ¨æ£€æŸ¥</strong>: å¦‚æœè‡ªåŠ¨æ£€æµ‹å¤±è´¥ï¼Œç‚¹å‡»"æ‰‹åŠ¨æ£€æŸ¥Redirectç»“æœ"</li>
            <li><strong>çŠ¶æ€é‡ç½®</strong>: ç‚¹å‡»"æ¸…é™¤æ‰€æœ‰è®¤è¯çŠ¶æ€"é‡æ–°å¼€å§‹</li>
            <li><strong>é¡µé¢åˆ·æ–°</strong>: ç‚¹å‡»"åˆ·æ–°é¡µé¢"é‡æ–°åŠ è½½</li>
        </ol>
    </div>

    <div class="warning">
        <h3>ğŸ”§ æ•…éšœæ’é™¤:</h3>
        <ul>
            <li><strong>æ— redirectç»“æœ</strong>: æ£€æŸ¥FirebaseæˆæƒåŸŸåé…ç½®</li>
            <li><strong>é‡å®šå‘å¤±è´¥</strong>: ç¡®è®¤å½“å‰åŸŸååœ¨Firebaseæ§åˆ¶å°ä¸­å·²æ·»åŠ </li>
            <li><strong>é•¿æ—¶é—´æ— å“åº”</strong>: å°è¯•æ‰‹åŠ¨æ£€æŸ¥æˆ–æ¸…é™¤çŠ¶æ€é‡è¯•</li>
            <li><strong>ç½‘ç»œé—®é¢˜</strong>: æ£€æŸ¥åç«¯æœåŠ¡å™¨æ˜¯å¦è¿è¡Œåœ¨3001ç«¯å£</li>
        </ul>
    </div>

    <div class="info">
        <p><strong>FirebaseæˆæƒåŸŸåæ£€æŸ¥:</strong> ç¡®ä¿åœ¨Firebaseæ§åˆ¶å°çš„Authentication â†’ Settings â†’ Authorized domainsä¸­æ·»åŠ äº† <code>localhost</code></p>
    </div>
</body>
</html> 