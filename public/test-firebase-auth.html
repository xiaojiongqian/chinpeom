<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebaseè®¤è¯æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .container {
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        .status {
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 5px solid;
        }
        .success {
            background: rgba(76, 175, 80, 0.2);
            border-color: #4CAF50;
        }
        .error {
            background: rgba(244, 67, 54, 0.2);
            border-color: #f44336;
        }
        .info {
            background: rgba(33, 150, 243, 0.2);
            border-color: #2196F3;
        }
        button {
            background: linear-gradient(45deg, #FF6B6B, #FF8E53);
            color: white;
            border: none;
            padding: 12px 24px;
            margin: 10px 5px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        .user-info {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
        }
        pre {
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”¥ Firebaseè®¤è¯ç«¯åˆ°ç«¯æµ‹è¯•</h1>
        
        <div id="status" class="status info">
            <strong>çŠ¶æ€:</strong> æ­£åœ¨åˆå§‹åŒ–Firebase...
        </div>

        <div>
            <button id="googleLogin" onclick="testGoogleLogin()">ğŸ”‘ Googleç™»å½•æµ‹è¯•</button>
            <button id="logout" onclick="testLogout()" disabled>ğŸšª ç™»å‡º</button>
            <button onclick="clearLog()">ğŸ§¹ æ¸…ç©ºæ—¥å¿—</button>
        </div>

        <div id="userInfo" class="user-info" style="display: none;">
            <h3>ğŸ‘¤ ç”¨æˆ·ä¿¡æ¯</h3>
            <div id="userDetails"></div>
        </div>

        <div id="tokenInfo" class="user-info" style="display: none;">
            <h3>ğŸ« Tokenä¿¡æ¯</h3>
            <div id="tokenDetails"></div>
        </div>

        <div>
            <h3>ğŸ“‹ æµ‹è¯•æ—¥å¿—</h3>
            <pre id="log"></pre>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.8.0/firebase-app.js'
        import { 
            getAuth, 
            GoogleAuthProvider, 
            signInWithPopup, 
            signOut, 
            onAuthStateChanged 
        } from 'https://www.gstatic.com/firebasejs/11.8.0/firebase-auth.js'

        // Firebaseé…ç½®
        const firebaseConfig = {
            apiKey: "AIzaSyCHt0r0EgWVt7xhOZS_piykzBcTSjKexek",
            authDomain: "poem2guess-8d19f.firebaseapp.com",
            projectId: "poem2guess-8d19f",
            storageBucket: "poem2guess-8d19f.firebasestorage.app",
            messagingSenderId: "542908264016",
            appId: "1:542908264016:web:f74fcb7d1a5db08a0b6a43"
        }

        // åˆå§‹åŒ–Firebase
        const app = initializeApp(firebaseConfig)
        const auth = getAuth(app)
        const googleProvider = new GoogleAuthProvider()

        // è®¾ç½®Google Providerå‚æ•°
        googleProvider.setCustomParameters({
            prompt: 'select_account'
        })

        let currentUser = null

        // ç›‘å¬è®¤è¯çŠ¶æ€å˜åŒ–
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user
                log(`âœ… Firebaseç”¨æˆ·çŠ¶æ€: å·²ç™»å½• - ${user.displayName || user.email}`)
                updateStatus('success', `å·²ç™»å½•: ${user.displayName || user.email}`)
                updateUserInfo(user)
                document.getElementById('googleLogin').disabled = true
                document.getElementById('logout').disabled = false
            } else {
                currentUser = null
                log('â„¹ï¸ Firebaseç”¨æˆ·çŠ¶æ€: æœªç™»å½•')
                updateStatus('info', 'æœªç™»å½•')
                hideUserInfo()
                document.getElementById('googleLogin').disabled = false
                document.getElementById('logout').disabled = true
            }
        })

        // Googleç™»å½•æµ‹è¯•
        window.testGoogleLogin = async function() {
            try {
                log('ğŸ”‘ å¼€å§‹Googleç™»å½•æµ‹è¯•...')
                updateStatus('info', 'æ­£åœ¨è¿›è¡ŒGoogleç™»å½•...')
                
                // 1. Firebase Googleç™»å½•
                const result = await signInWithPopup(auth, googleProvider)
                const user = result.user
                
                log(`âœ… Firebaseç™»å½•æˆåŠŸ: ${user.displayName}`)
                
                // 2. è·å–ID Token
                const idToken = await user.getIdToken()
                log(`ğŸ« è·å–Firebase ID TokenæˆåŠŸ (é•¿åº¦: ${idToken.length})`)
                
                // 3. è°ƒç”¨åç«¯APIç™»å½•
                log('ğŸŒ è°ƒç”¨åç«¯ç™»å½•API...')
                const response = await fetch('http://localhost:3001/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        provider: 'google',
                        access_token: idToken,
                        firebase_uid: user.uid
                    })
                })

                if (response.ok) {
                    const data = await response.json()
                    log(`âœ… åç«¯ç™»å½•æˆåŠŸ: ${data.user.display_name}`)
                    updateStatus('success', `ç«¯åˆ°ç«¯ç™»å½•æˆåŠŸ: ${data.user.display_name}`)
                    
                    // æ˜¾ç¤ºå®Œæ•´çš„ç”¨æˆ·ä¿¡æ¯
                    updateTokenInfo(idToken, data)
                } else {
                    const errorData = await response.json()
                    log(`âŒ åç«¯ç™»å½•å¤±è´¥: ${errorData.message}`)
                    updateStatus('error', `åç«¯ç™»å½•å¤±è´¥: ${errorData.message}`)
                }

            } catch (error) {
                log(`âŒ ç™»å½•æµ‹è¯•å¤±è´¥: ${error.message}`)
                updateStatus('error', `ç™»å½•å¤±è´¥: ${error.message}`)
                console.error('ç™»å½•é”™è¯¯:', error)
            }
        }

        // ç™»å‡ºæµ‹è¯•
        window.testLogout = async function() {
            try {
                log('ğŸšª å¼€å§‹ç™»å‡ºæµ‹è¯•...')
                await signOut(auth)
                log('âœ… ç™»å‡ºæˆåŠŸ')
                updateStatus('info', 'å·²ç™»å‡º')
                hideUserInfo()
            } catch (error) {
                log(`âŒ ç™»å‡ºå¤±è´¥: ${error.message}`)
                updateStatus('error', `ç™»å‡ºå¤±è´¥: ${error.message}`)
            }
        }

        // æ¸…ç©ºæ—¥å¿—
        window.clearLog = function() {
            document.getElementById('log').textContent = ''
        }

        // æ—¥å¿—è®°å½•
        function log(message) {
            const timestamp = new Date().toLocaleTimeString()
            const logElement = document.getElementById('log')
            logElement.textContent += `[${timestamp}] ${message}\n`
            logElement.scrollTop = logElement.scrollHeight
        }

        // æ›´æ–°çŠ¶æ€
        function updateStatus(type, message) {
            const statusElement = document.getElementById('status')
            statusElement.className = `status ${type}`
            statusElement.innerHTML = `<strong>çŠ¶æ€:</strong> ${message}`
        }

        // æ›´æ–°ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤º
        function updateUserInfo(user) {
            const userInfoElement = document.getElementById('userInfo')
            const userDetailsElement = document.getElementById('userDetails')
            
            userDetailsElement.innerHTML = `
                <p><strong>UID:</strong> ${user.uid}</p>
                <p><strong>æ˜¾ç¤ºåç§°:</strong> ${user.displayName || 'æœªè®¾ç½®'}</p>
                <p><strong>é‚®ç®±:</strong> ${user.email}</p>
                <p><strong>å¤´åƒ:</strong> ${user.photoURL ? `<img src="${user.photoURL}" style="width: 32px; height: 32px; border-radius: 50%; vertical-align: middle;">` : 'æ— '}</p>
                <p><strong>é‚®ç®±éªŒè¯:</strong> ${user.emailVerified ? 'å·²éªŒè¯' : 'æœªéªŒè¯'}</p>
                <p><strong>åˆ›å»ºæ—¶é—´:</strong> ${new Date(user.metadata.creationTime).toLocaleString()}</p>
                <p><strong>æœ€åç™»å½•:</strong> ${new Date(user.metadata.lastSignInTime).toLocaleString()}</p>
            `
            userInfoElement.style.display = 'block'
        }

        // æ›´æ–°Tokenä¿¡æ¯æ˜¾ç¤º
        function updateTokenInfo(idToken, backendData) {
            const tokenInfoElement = document.getElementById('tokenInfo')
            const tokenDetailsElement = document.getElementById('tokenDetails')
            
            // è§£æJWT Tokenï¼ˆä»…ç”¨äºæ˜¾ç¤ºï¼Œä¸éªŒè¯ç­¾åï¼‰
            const tokenParts = idToken.split('.')
            let tokenPayload = {}
            try {
                tokenPayload = JSON.parse(atob(tokenParts[1]))
            } catch (e) {
                tokenPayload = { error: 'æ— æ³•è§£ætoken' }
            }
            
            tokenDetailsElement.innerHTML = `
                <p><strong>Firebase ID Tokené•¿åº¦:</strong> ${idToken.length}</p>
                <p><strong>Tokenè¿‡æœŸæ—¶é—´:</strong> ${new Date(tokenPayload.exp * 1000).toLocaleString()}</p>
                <p><strong>åç«¯ç”¨æˆ·ID:</strong> ${backendData.user.id}</p>
                <p><strong>åç«¯JWT:</strong> ${backendData.token.substring(0, 50)}...</p>
                <p><strong>Tokenæœ‰æ•ˆæœŸ:</strong> ${Math.floor(backendData.expires_in / 3600 / 24)}å¤©</p>
            `
            tokenInfoElement.style.display = 'block'
        }

        // éšè—ç”¨æˆ·ä¿¡æ¯
        function hideUserInfo() {
            document.getElementById('userInfo').style.display = 'none'
            document.getElementById('tokenInfo').style.display = 'none'
        }

        // åˆå§‹åŒ–å®Œæˆ
        log('ğŸš€ Firebaseè®¤è¯æµ‹è¯•é¡µé¢åˆå§‹åŒ–å®Œæˆ')
        updateStatus('info', 'Firebaseå·²åˆå§‹åŒ–ï¼Œå‡†å¤‡æµ‹è¯•')
    </script>
</body>
</html> 