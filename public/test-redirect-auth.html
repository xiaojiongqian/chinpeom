<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Redirectè®¤è¯æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
        }
        .success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .info {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .json-display {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
        }
    </style>
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js'
        import { 
            getAuth, 
            GoogleAuthProvider, 
            signInWithRedirect,
            getRedirectResult,
            signOut 
        } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js'

        // Firebaseé…ç½®
        const firebaseConfig = {
            apiKey: "AIzaSyCHt0r0EgWVt7xhOZS_piykzBcTSjKexek",
            authDomain: "poem2guess-8d19f.firebaseapp.com",
            projectId: "poem2guess-8d19f",
            storageBucket: "poem2guess-8d19f.firebasestorage.app",
            messagingSenderId: "521053998371",
            appId: "1:521053998371:web:5a8c5e7b8ec4d8f75f5e5d"
        }

        // åˆå§‹åŒ–Firebase
        const app = initializeApp(firebaseConfig)
        const auth = getAuth(app)
        const googleProvider = new GoogleAuthProvider()

        // çŠ¶æ€ç®¡ç†
        let isLoading = false

        // DOMå…ƒç´ 
        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status')
            statusDiv.className = `status ${type}`
            statusDiv.textContent = message
        }

        function updateUserInfo(userInfo) {
            const userDiv = document.getElementById('userInfo')
            userDiv.innerHTML = '<h3>ç”¨æˆ·ä¿¡æ¯:</h3>' + JSON.stringify(userInfo, null, 2)
        }

        function updateTokenInfo(tokenInfo) {
            const tokenDiv = document.getElementById('tokenInfo')
            tokenDiv.innerHTML = '<h3>Tokenä¿¡æ¯:</h3>' + JSON.stringify(tokenInfo, null, 2)
        }

        function updateBackendResponse(response) {
            const backendDiv = document.getElementById('backendResponse')
            backendDiv.innerHTML = '<h3>åç«¯å“åº”:</h3>' + JSON.stringify(response, null, 2)
        }

        // è®¾ç½®æŒ‰é’®çŠ¶æ€
        function setButtonsEnabled(enabled) {
            const buttons = document.querySelectorAll('button')
            buttons.forEach(btn => {
                btn.disabled = !enabled
            })
        }

        // Redirectç™»å½•ï¼ˆç›´æ¥ä½¿ç”¨redirectæ¨¡å¼ï¼‰
        window.redirectLogin = async function() {
            if (isLoading) return
            
            try {
                isLoading = true
                setButtonsEnabled(false)
                updateStatus('æ­£åœ¨å¯åŠ¨Google Redirectè®¤è¯...', 'info')
                
                // ç›´æ¥ä½¿ç”¨redirectè®¤è¯ï¼Œä¸å°è¯•popup
                await signInWithRedirect(auth, googleProvider)
                
                // æ³¨æ„ï¼šredirectåé¡µé¢ä¼šè·³è½¬ï¼Œè¿™é‡Œçš„ä»£ç ä¸ä¼šæ‰§è¡Œ
                updateStatus('æ­£åœ¨è·³è½¬åˆ°Googleè®¤è¯é¡µé¢...', 'info')
                
            } catch (error) {
                console.error('Redirectè®¤è¯å¯åŠ¨å¤±è´¥:', error)
                updateStatus(`Redirectè®¤è¯å¯åŠ¨å¤±è´¥: ${error.message}`, 'error')
                isLoading = false
                setButtonsEnabled(true)
            }
        }

        // æ£€æŸ¥redirectç»“æœ
        window.checkRedirectResult = async function() {
            if (isLoading) return
            
            try {
                isLoading = true
                setButtonsEnabled(false)
                updateStatus('æ£€æŸ¥Redirectè®¤è¯ç»“æœ...', 'info')
                
                const result = await getRedirectResult(auth)
                
                if (result) {
                    const user = result.user
                    const idToken = await user.getIdToken()
                    
                    // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
                    const userInfo = {
                        uid: user.uid,
                        email: user.email,
                        displayName: user.displayName,
                        photoURL: user.photoURL,
                        emailVerified: user.emailVerified
                    }
                    updateUserInfo(userInfo)
                    
                    // æ˜¾ç¤ºTokenä¿¡æ¯
                    const tokenInfo = {
                        idToken: idToken.substring(0, 50) + '...',
                        tokenLength: idToken.length
                    }
                    updateTokenInfo(tokenInfo)
                    
                    updateStatus('Redirectè®¤è¯æˆåŠŸï¼æ­£åœ¨å‘é€åˆ°åç«¯éªŒè¯...', 'success')
                    
                    // å‘é€åˆ°åç«¯éªŒè¯
                    await testBackendAuth(idToken, user.uid)
                    
                } else {
                    updateStatus('æ²¡æœ‰æ£€æµ‹åˆ°Redirectè®¤è¯ç»“æœ', 'info')
                }
                
            } catch (error) {
                console.error('æ£€æŸ¥Redirectç»“æœå¤±è´¥:', error)
                updateStatus(`æ£€æŸ¥Redirectç»“æœå¤±è´¥: ${error.message}`, 'error')
            } finally {
                isLoading = false
                setButtonsEnabled(true)
            }
        }

        // æµ‹è¯•åç«¯è®¤è¯
        async function testBackendAuth(idToken, firebaseUid) {
            try {
                updateStatus('æ­£åœ¨éªŒè¯åç«¯è®¤è¯...', 'info')
                
                const response = await fetch('http://localhost:3001/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        provider: 'google',
                        access_token: idToken,
                        firebase_uid: firebaseUid
                    })
                })

                const data = await response.json()
                
                if (response.ok) {
                    updateStatus('âœ… åç«¯è®¤è¯æˆåŠŸï¼æ•´ä¸ªæµç¨‹å®Œæˆï¼', 'success')
                    updateBackendResponse(data)
                } else {
                    updateStatus(`âŒ åç«¯è®¤è¯å¤±è´¥: ${data.message}`, 'error')
                    updateBackendResponse(data)
                }
                
            } catch (error) {
                console.error('åç«¯è®¤è¯æµ‹è¯•å¤±è´¥:', error)
                updateStatus(`åç«¯è®¤è¯æµ‹è¯•å¤±è´¥: ${error.message}`, 'error')
            }
        }

        // ç™»å‡º
        window.logout = async function() {
            if (isLoading) return
            
            try {
                isLoading = true
                setButtonsEnabled(false)
                updateStatus('æ­£åœ¨ç™»å‡º...', 'info')
                
                await signOut(auth)
                
                // æ¸…ç©ºæ˜¾ç¤ºä¿¡æ¯
                document.getElementById('userInfo').innerHTML = ''
                document.getElementById('tokenInfo').innerHTML = ''
                document.getElementById('backendResponse').innerHTML = ''
                
                updateStatus('å·²ç™»å‡º', 'success')
                
            } catch (error) {
                console.error('ç™»å‡ºå¤±è´¥:', error)
                updateStatus(`ç™»å‡ºå¤±è´¥: ${error.message}`, 'error')
            } finally {
                isLoading = false
                setButtonsEnabled(true)
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥redirectç»“æœ
        window.addEventListener('load', () => {
            updateStatus('é¡µé¢å·²åŠ è½½ï¼Œè‡ªåŠ¨æ£€æŸ¥Redirectè®¤è¯ç»“æœ...', 'info')
            checkRedirectResult()
        })

        // ç›‘å¬è®¤è¯çŠ¶æ€å˜åŒ–
        auth.onAuthStateChanged((user) => {
            if (user) {
                console.log('Firebaseè®¤è¯çŠ¶æ€: å·²ç™»å½•', user.displayName)
            } else {
                console.log('Firebaseè®¤è¯çŠ¶æ€: æœªç™»å½•')
            }
        })
    </script>
</head>
<body>
    <h1>ğŸ”„ Firebase Redirectè®¤è¯æµ‹è¯•</h1>
    
    <div class="info">
        <strong>è¯´æ˜:</strong> è¿™ä¸ªé¡µé¢ä¸“é—¨æµ‹è¯•Firebaseçš„Redirectè®¤è¯æ¨¡å¼ï¼Œé¿å…CORSé—®é¢˜ã€‚
        <ul>
            <li>ç‚¹å‡»"å¯åŠ¨Redirectç™»å½•"å°†è·³è½¬åˆ°Googleè®¤è¯é¡µé¢</li>
            <li>è®¤è¯å®Œæˆåä¼šè‡ªåŠ¨è¿”å›æ­¤é¡µé¢å¹¶å¤„ç†ç»“æœ</li>
            <li>é¡µé¢åŠ è½½æ—¶ä¼šè‡ªåŠ¨æ£€æŸ¥redirectè®¤è¯ç»“æœ</li>
        </ul>
    </div>

    <div id="status" class="status info">å‡†å¤‡å°±ç»ª</div>
    
    <div style="margin: 20px 0;">
        <button onclick="redirectLogin()">ğŸš€ å¯åŠ¨Redirectç™»å½•</button>
        <button onclick="checkRedirectResult()">ğŸ” æ£€æŸ¥Redirectç»“æœ</button>
        <button onclick="logout()">ğŸšª ç™»å‡º</button>
    </div>

    <div id="userInfo" class="json-display"></div>
    <div id="tokenInfo" class="json-display"></div>
    <div id="backendResponse" class="json-display"></div>

    <div class="info">
        <h3>ğŸ“‹ æµ‹è¯•æ­¥éª¤:</h3>
        <ol>
            <li>ç‚¹å‡»"å¯åŠ¨Redirectç™»å½•"æŒ‰é’®</li>
            <li>é¡µé¢ä¼šè·³è½¬åˆ°Googleè®¤è¯é¡µé¢</li>
            <li>å®ŒæˆGoogleè´¦å·ç™»å½•</li>
            <li>è‡ªåŠ¨è¿”å›æ­¤é¡µé¢å¹¶æ˜¾ç¤ºè®¤è¯ç»“æœ</li>
            <li>è‡ªåŠ¨è¿›è¡Œåç«¯APIéªŒè¯</li>
        </ol>
    </div>

    <div class="info">
        <h3>ğŸ”§ æ•…éšœæ’é™¤:</h3>
        <ul>
            <li>å¦‚æœredirectåæ²¡æœ‰è‡ªåŠ¨æ£€æŸ¥ç»“æœï¼Œè¯·æ‰‹åŠ¨ç‚¹å‡»"æ£€æŸ¥Redirectç»“æœ"</li>
            <li>ç¡®ä¿åç«¯æœåŠ¡è¿è¡Œåœ¨ http://localhost:3001</li>
            <li>æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰é”™è¯¯ä¿¡æ¯</li>
        </ul>
    </div>
</body>
</html> 