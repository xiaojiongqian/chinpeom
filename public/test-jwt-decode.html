<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JWT Tokenè§£ææµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
        }
        .success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .info {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .json-display {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        textarea {
            width: 100%;
            height: 120px;
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <h1>ğŸ” JWT Tokenè§£ææµ‹è¯•</h1>
    
    <div class="info">
        <strong>ç›®çš„:</strong> æµ‹è¯•æˆ‘ä»¬çš„ç®€åŒ–éªŒè¯é€»è¾‘ï¼Œè§£æFirebase ID Tokençš„payloadéƒ¨åˆ†
    </div>

    <div id="status" class="status info">å‡†å¤‡è§£æJWT Token...</div>

    <h3>æ–¹æ³•1: ä»Firebaseè·å–çœŸå®Token</h3>
    <button onclick="getFirebaseToken()">ğŸ”‘ è·å–Firebase Token</button>
    <button onclick="testTokenWithBackend()">ğŸ”§ æµ‹è¯•åç«¯éªŒè¯</button>

    <h3>æ–¹æ³•2: æ‰‹åŠ¨è¾“å…¥Tokenè¿›è¡Œè§£æ</h3>
    <textarea id="tokenInput" placeholder="åœ¨æ­¤è¾“å…¥Firebase ID Tokenè¿›è¡Œè§£æ..."></textarea>
    <button onclick="parseManualToken()">ğŸ” è§£ææ‰‹åŠ¨è¾“å…¥çš„Token</button>

    <div id="tokenInfo" class="json-display"></div>
    <div id="payloadInfo" class="json-display"></div>
    <div id="backendResponse" class="json-display"></div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js'
        import { 
            getAuth, 
            GoogleAuthProvider, 
            signInWithPopup,
            signOut,
            onAuthStateChanged
        } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js'

        // Firebaseé…ç½®
        const firebaseConfig = {
            apiKey: "AIzaSyCHt0r0EgWVt7xhOZS_piykzBcTSjKexek",
            authDomain: "poem2guess-8d19f.firebaseapp.com",
            projectId: "poem2guess-8d19f",
            storageBucket: "poem2guess-8d19f.firebasestorage.app",
            messagingSenderId: "521053998371",
            appId: "1:521053998371:web:5a8c5e7b8ec4d8f75f5e5d"
        }

        // åˆå§‹åŒ–Firebase
        const app = initializeApp(firebaseConfig)
        const auth = getAuth(app)
        const googleProvider = new GoogleAuthProvider()

        let currentToken = null

        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status')
            statusDiv.className = `status ${type}`
            statusDiv.textContent = message
        }

        function updateTokenInfo(tokenInfo) {
            const tokenDiv = document.getElementById('tokenInfo')
            tokenDiv.innerHTML = '<h3>ğŸ”‘ Tokenä¿¡æ¯:</h3>' + JSON.stringify(tokenInfo, null, 2)
        }

        function updatePayloadInfo(payloadInfo) {
            const payloadDiv = document.getElementById('payloadInfo')
            payloadDiv.innerHTML = '<h3>ğŸ“‹ Token Payloadè§£æ:</h3>' + JSON.stringify(payloadInfo, null, 2)
        }

        function updateBackendResponse(response) {
            const backendDiv = document.getElementById('backendResponse')
            backendDiv.innerHTML = '<h3>ğŸ”§ åç«¯éªŒè¯å“åº”:</h3>' + JSON.stringify(response, null, 2)
        }

        // è§£æJWT Token
        function parseJWT(token) {
            try {
                if (!token || typeof token !== 'string') {
                    throw new Error('Tokenä¸ºç©ºæˆ–æ ¼å¼é”™è¯¯')
                }

                const parts = token.split('.')
                if (parts.length !== 3) {
                    throw new Error('JWTæ ¼å¼é”™è¯¯ï¼Œåº”è¯¥æœ‰3ä¸ªéƒ¨åˆ†')
                }

                // è§£æheader
                const header = JSON.parse(atob(parts[0]))
                
                // è§£æpayload
                const payload = JSON.parse(atob(parts[1]))
                
                // è®¡ç®—æ—¶é—´ä¿¡æ¯
                const now = Math.floor(Date.now() / 1000)
                const timeInfo = {
                    ç°åœ¨: new Date(now * 1000).toLocaleString(),
                    ç­¾å‘æ—¶é—´: payload.iat ? new Date(payload.iat * 1000).toLocaleString() : 'æœªè®¾ç½®',
                    è¿‡æœŸæ—¶é—´: payload.exp ? new Date(payload.exp * 1000).toLocaleString() : 'æœªè®¾ç½®',
                    è®¤è¯æ—¶é—´: payload.auth_time ? new Date(payload.auth_time * 1000).toLocaleString() : 'æœªè®¾ç½®',
                    æ˜¯å¦è¿‡æœŸ: payload.exp ? (payload.exp < now ? 'æ˜¯' : 'å¦') : 'æ— æ³•åˆ¤æ–­'
                }

                return {
                    header,
                    payload,
                    timeInfo,
                    signature: parts[2].substring(0, 20) + '...'
                }
            } catch (error) {
                throw new Error('JWTè§£æå¤±è´¥: ' + error.message)
            }
        }

        // è·å–Firebase Token
        window.getFirebaseToken = async function() {
            try {
                updateStatus('ğŸ”‘ æ­£åœ¨è·å–Firebase Token...', 'info')

                // æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
                if (!auth.currentUser) {
                    updateStatus('ğŸ” éœ€è¦å…ˆç™»å½•ï¼Œæ­£åœ¨å¯åŠ¨Googleè®¤è¯...', 'info')
                    const result = await signInWithPopup(auth, googleProvider)
                }

                // è·å–ID Token
                const idToken = await auth.currentUser.getIdToken(true) // å¼ºåˆ¶åˆ·æ–°
                currentToken = idToken

                // æ˜¾ç¤ºTokenåŸºæœ¬ä¿¡æ¯
                const tokenInfo = {
                    tokenLength: idToken.length,
                    tokenPreview: idToken.substring(0, 50) + '...',
                    userId: auth.currentUser.uid,
                    userEmail: auth.currentUser.email
                }
                updateTokenInfo(tokenInfo)

                // è§£æToken
                const parsed = parseJWT(idToken)
                updatePayloadInfo(parsed)

                updateStatus('âœ… Firebase Tokenè·å–å¹¶è§£ææˆåŠŸï¼', 'success')

            } catch (error) {
                console.error('è·å–Firebase Tokenå¤±è´¥:', error)
                updateStatus(`âŒ è·å–Firebase Tokenå¤±è´¥: ${error.message}`, 'error')
            }
        }

        // è§£ææ‰‹åŠ¨è¾“å…¥çš„Token
        window.parseManualToken = function() {
            try {
                const token = document.getElementById('tokenInput').value.trim()
                if (!token) {
                    updateStatus('âš ï¸ è¯·è¾“å…¥Token', 'error')
                    return
                }

                updateStatus('ğŸ” æ­£åœ¨è§£ææ‰‹åŠ¨è¾“å…¥çš„Token...', 'info')

                // æ˜¾ç¤ºTokenåŸºæœ¬ä¿¡æ¯
                const tokenInfo = {
                    tokenLength: token.length,
                    tokenPreview: token.substring(0, 50) + '...',
                    source: 'æ‰‹åŠ¨è¾“å…¥'
                }
                updateTokenInfo(tokenInfo)

                // è§£æToken
                const parsed = parseJWT(token)
                updatePayloadInfo(parsed)

                currentToken = token
                updateStatus('âœ… Tokenè§£ææˆåŠŸï¼', 'success')

            } catch (error) {
                console.error('è§£æTokenå¤±è´¥:', error)
                updateStatus(`âŒ è§£æTokenå¤±è´¥: ${error.message}`, 'error')
            }
        }

        // æµ‹è¯•åç«¯éªŒè¯
        window.testTokenWithBackend = async function() {
            try {
                if (!currentToken) {
                    updateStatus('âš ï¸ è¯·å…ˆè·å–æˆ–è¾“å…¥Token', 'error')
                    return
                }

                updateStatus('ğŸ”§ æ­£åœ¨æµ‹è¯•åç«¯éªŒè¯...', 'info')

                const response = await fetch('http://localhost:3001/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        provider: 'google',
                        access_token: currentToken,
                        firebase_uid: 'test-uid'
                    })
                })

                const data = await response.json()

                if (response.ok) {
                    updateStatus('âœ… åç«¯éªŒè¯æˆåŠŸï¼ç®€åŒ–éªŒè¯æ¨¡å¼å·¥ä½œæ­£å¸¸ï¼', 'success')
                    updateBackendResponse({
                        status: 'æˆåŠŸ',
                        response: data
                    })
                } else {
                    updateStatus(`âŒ åç«¯éªŒè¯å¤±è´¥: ${data.message}`, 'error')
                    updateBackendResponse({
                        status: 'å¤±è´¥',
                        response: data
                    })
                }

            } catch (error) {
                console.error('åç«¯éªŒè¯æµ‹è¯•å¤±è´¥:', error)
                updateStatus(`âŒ åç«¯éªŒè¯æµ‹è¯•å¤±è´¥: ${error.message}`, 'error')
                updateBackendResponse({
                    status: 'ç½‘ç»œé”™è¯¯',
                    error: error.message
                })
            }
        }

        // ç›‘å¬è®¤è¯çŠ¶æ€
        onAuthStateChanged(auth, (user) => {
            if (user) {
                console.log('å½“å‰å·²ç™»å½•:', user.email)
            } else {
                console.log('å½“å‰æœªç™»å½•')
            }
        })
    </script>

    <div class="info">
        <h3>ğŸ“‹ ä½¿ç”¨è¯´æ˜:</h3>
        <ol>
            <li>ç‚¹å‡»"è·å–Firebase Token"è¿›è¡ŒGoogleç™»å½•å¹¶è·å–çœŸå®Token</li>
            <li>æˆ–è€…æ‰‹åŠ¨ç²˜è´´å·²æœ‰çš„Firebase ID Tokenè¿›è¡Œè§£æ</li>
            <li>è§£ææˆåŠŸåï¼Œç‚¹å‡»"æµ‹è¯•åç«¯éªŒè¯"éªŒè¯æˆ‘ä»¬çš„ç®€åŒ–éªŒè¯é€»è¾‘</li>
            <li>æŸ¥çœ‹è§£æç»“æœï¼Œç¡®è®¤Tokençš„æœ‰æ•ˆæ€§å’Œå­—æ®µå®Œæ•´æ€§</li>
        </ol>
    </div>

    <div class="info">
        <h3>ğŸ” æ£€æŸ¥è¦ç‚¹:</h3>
        <ul>
            <li><strong>Tokenç»“æ„</strong>: ç¡®è®¤JWTæœ‰3ä¸ªéƒ¨åˆ† (header.payload.signature)</li>
            <li><strong>é¡¹ç›®ID</strong>: audå­—æ®µåº”è¯¥æ˜¯ "poem2guess-8d19f"</li>
            <li><strong>å‘è¡Œè€…</strong>: isså­—æ®µåº”è¯¥åŒ…å« "securetoken.google.com"</li>
            <li><strong>æœ‰æ•ˆæœŸ</strong>: expå­—æ®µåº”è¯¥å¤§äºå½“å‰æ—¶é—´</li>
            <li><strong>åç«¯éªŒè¯</strong>: æˆ‘ä»¬çš„ç®€åŒ–éªŒè¯åº”è¯¥æˆåŠŸè§£æToken</li>
        </ul>
    </div>
</body>
</html> 