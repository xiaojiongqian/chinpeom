<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebaseé…ç½®è¯Šæ–­</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
        }
        .success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .info {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        .warning {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .json-display {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .check-item {
            margin: 15px 0;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .check-pass {
            border-color: #28a745;
            background-color: #d4edda;
        }
        .check-fail {
            border-color: #dc3545;
            background-color: #f8d7da;
        }
        .check-warning {
            border-color: #ffc107;
            background-color: #fff3cd;
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ Firebaseé…ç½®è¯Šæ–­</h1>
    
    <div class="warning">
        <strong>ç›®æ ‡:</strong> æ£€æŸ¥Firebaseé¡¹ç›®é…ç½®ï¼Œè¯Šæ–­redirectè®¤è¯æ— æ³•æ£€æµ‹ç»“æœçš„é—®é¢˜
    </div>

    <div id="status" class="status info">å¼€å§‹Firebaseé…ç½®è¯Šæ–­...</div>

    <button onclick="runFullDiagnosis()">ğŸ” è¿è¡Œå®Œæ•´è¯Šæ–­</button>
    <button onclick="testAuthDomains()">ğŸŒ æµ‹è¯•æˆæƒåŸŸå</button>
    <button onclick="checkFirebaseConnection()">ğŸ”¥ æ£€æŸ¥Firebaseè¿æ¥</button>

    <h3>ğŸ“‹ è¯Šæ–­ç»“æœ</h3>
    <div id="diagnostics"></div>

    <h3>ğŸ”§ è¯¦ç»†ä¿¡æ¯</h3>
    <div id="details" class="json-display"></div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js'
        import { 
            getAuth, 
            GoogleAuthProvider
        } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js'

        // Firebaseé…ç½®
        const firebaseConfig = {
            apiKey: "AIzaSyCHt0r0EgWVt7xhOZS_piykzBcTSjKexek",
            authDomain: "poem2guess-8d19f.firebaseapp.com",
            projectId: "poem2guess-8d19f",
            storageBucket: "poem2guess-8d19f.firebasestorage.app",
            messagingSenderId: "521053998371",
            appId: "1:521053998371:web:5a8c5e7b8ec4d8f75f5e5d"
        }

        let app, auth, googleProvider
        let diagnosticResults = []

        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status')
            statusDiv.className = `status ${type}`
            statusDiv.textContent = message
        }

        function addDiagnostic(title, status, message, details = null) {
            const diagnostic = {
                title,
                status, // 'pass', 'fail', 'warning'
                message,
                details,
                timestamp: new Date().toLocaleTimeString()
            }
            diagnosticResults.push(diagnostic)
            updateDiagnosticsDisplay()
        }

        function updateDiagnosticsDisplay() {
            const diagnosticsDiv = document.getElementById('diagnostics')
            diagnosticsDiv.innerHTML = diagnosticResults.map(diag => `
                <div class="check-item check-${diag.status}">
                    <strong>${diag.status === 'pass' ? 'âœ…' : diag.status === 'fail' ? 'âŒ' : 'âš ï¸'} ${diag.title}</strong><br>
                    ${diag.message}<br>
                    <small>æ—¶é—´: ${diag.timestamp}</small>
                </div>
            `).join('')
        }

        function updateDetails(details) {
            document.getElementById('details').textContent = JSON.stringify(details, null, 2)
        }

        // åˆå§‹åŒ–Firebase
        function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig)
                auth = getAuth(app)
                googleProvider = new GoogleAuthProvider()
                
                addDiagnostic(
                    'Firebaseåˆå§‹åŒ–',
                    'pass',
                    'Firebase SDKåˆå§‹åŒ–æˆåŠŸ'
                )
                return true
            } catch (error) {
                addDiagnostic(
                    'Firebaseåˆå§‹åŒ–',
                    'fail',
                    `Firebase SDKåˆå§‹åŒ–å¤±è´¥: ${error.message}`,
                    error
                )
                return false
            }
        }

        // æ£€æŸ¥å½“å‰ç¯å¢ƒ
        function checkEnvironment() {
            const currentDomain = window.location.hostname
            const currentPort = window.location.port
            const currentProtocol = window.location.protocol
            const fullUrl = window.location.href

            const envDetails = {
                'å½“å‰åŸŸå': currentDomain,
                'å½“å‰ç«¯å£': currentPort,
                'å½“å‰åè®®': currentProtocol,
                'å®Œæ•´URL': fullUrl,
                'æ˜¯å¦localhost': currentDomain === 'localhost',
                'æ˜¯å¦127_0_0_1': currentDomain === '127.0.0.1',
                'æ˜¯å¦HTTPS': currentProtocol === 'https:',
                'æµè§ˆå™¨': navigator.userAgent.substring(0, 100) + '...'
            }

            // æ£€æŸ¥åŸŸå
            if (currentDomain === 'localhost') {
                addDiagnostic(
                    'å½“å‰åŸŸåæ£€æŸ¥',
                    'pass',
                    'æ­£åœ¨ä½¿ç”¨localhoståŸŸåï¼Œè¿™æ˜¯æ¨èçš„å¼€å‘ç¯å¢ƒåŸŸå'
                )
            } else if (currentDomain === '127.0.0.1') {
                addDiagnostic(
                    'å½“å‰åŸŸåæ£€æŸ¥',
                    'warning',
                    'æ­£åœ¨ä½¿ç”¨127.0.0.1ï¼Œå»ºè®®ä½¿ç”¨localhostä»¥è·å¾—æ›´å¥½çš„Firebaseå…¼å®¹æ€§'
                )
            } else {
                addDiagnostic(
                    'å½“å‰åŸŸåæ£€æŸ¥',
                    'warning',
                    `æ­£åœ¨ä½¿ç”¨è‡ªå®šä¹‰åŸŸå: ${currentDomain}ï¼Œç¡®ä¿å·²åœ¨Firebaseæ§åˆ¶å°æ·»åŠ æ­¤åŸŸå`
                )
            }

            // æ£€æŸ¥åè®®
            if (currentProtocol === 'https:') {
                addDiagnostic(
                    'åè®®æ£€æŸ¥',
                    'pass',
                    'æ­£åœ¨ä½¿ç”¨HTTPSåè®®ï¼Œå®‰å…¨ä¸”å…¼å®¹æ€§å¥½'
                )
            } else {
                addDiagnostic(
                    'åè®®æ£€æŸ¥',
                    'warning',
                    'æ­£åœ¨ä½¿ç”¨HTTPåè®®ï¼ŒæŸäº›FirebaseåŠŸèƒ½å¯èƒ½å—é™'
                )
            }

            return envDetails
        }

        // æ£€æŸ¥Firebaseé¡¹ç›®é…ç½®
        function checkFirebaseProject() {
            const projectDetails = {
                'é¡¹ç›®ID': firebaseConfig.projectId,
                'è®¤è¯åŸŸå': firebaseConfig.authDomain,
                'APIå¯†é’¥': firebaseConfig.apiKey.substring(0, 20) + '...',
                'åº”ç”¨ID': firebaseConfig.appId,
                'å­˜å‚¨æ¡¶': firebaseConfig.storageBucket
            }

            // æ£€æŸ¥é¡¹ç›®ID
            if (firebaseConfig.projectId === 'poem2guess-8d19f') {
                addDiagnostic(
                    'Firebaseé¡¹ç›®ID',
                    'pass',
                    'é¡¹ç›®IDé…ç½®æ­£ç¡®'
                )
            } else {
                addDiagnostic(
                    'Firebaseé¡¹ç›®ID',
                    'fail',
                    `é¡¹ç›®IDä¸åŒ¹é…ï¼ŒæœŸæœ›: poem2guess-8d19f, å®é™…: ${firebaseConfig.projectId}`
                )
            }

            // æ£€æŸ¥è®¤è¯åŸŸå
            if (firebaseConfig.authDomain === 'poem2guess-8d19f.firebaseapp.com') {
                addDiagnostic(
                    'Firebaseè®¤è¯åŸŸå',
                    'pass',
                    'è®¤è¯åŸŸåé…ç½®æ­£ç¡®'
                )
            } else {
                addDiagnostic(
                    'Firebaseè®¤è¯åŸŸå',
                    'fail',
                    `è®¤è¯åŸŸåä¸åŒ¹é…ï¼ŒæœŸæœ›: poem2guess-8d19f.firebaseapp.com, å®é™…: ${firebaseConfig.authDomain}`
                )
            }

            return projectDetails
        }

        // æµ‹è¯•Firebaseè¿æ¥
        window.checkFirebaseConnection = async function() {
            try {
                updateStatus('ğŸ”¥ æ£€æŸ¥Firebaseè¿æ¥...', 'info')

                // æµ‹è¯•è®¤è¯è¿æ¥
                const currentUser = auth.currentUser
                
                // å°è¯•è·å–Authå®ä¾‹çŠ¶æ€
                const authState = {
                    'å½“å‰ç”¨æˆ·': currentUser ? {
                        uid: currentUser.uid,
                        email: currentUser.email,
                        displayName: currentUser.displayName
                    } : null,
                    'Authå®ä¾‹': !!auth,
                    'Google Provider': !!googleProvider,
                    'é…ç½®çŠ¶æ€': 'Firebase Authåˆå§‹åŒ–æˆåŠŸ'
                }

                addDiagnostic(
                    'Firebaseè¿æ¥æµ‹è¯•',
                    'pass',
                    'Firebase AuthæœåŠ¡è¿æ¥æ­£å¸¸'
                )

                updateDetails({
                    'Firebaseè¿æ¥æµ‹è¯•': authState
                })

                updateStatus('âœ… Firebaseè¿æ¥æ£€æŸ¥å®Œæˆ', 'success')

            } catch (error) {
                addDiagnostic(
                    'Firebaseè¿æ¥æµ‹è¯•',
                    'fail',
                    `Firebaseè¿æ¥å¤±è´¥: ${error.message}`,
                    error
                )
                updateStatus('âŒ Firebaseè¿æ¥æ£€æŸ¥å¤±è´¥', 'error')
            }
        }

        // æµ‹è¯•æˆæƒåŸŸå
        window.testAuthDomains = async function() {
            try {
                updateStatus('ğŸŒ æµ‹è¯•æˆæƒåŸŸåé…ç½®...', 'info')

                const currentDomain = window.location.hostname
                const expectedDomains = ['localhost']
                
                // æ£€æŸ¥å½“å‰åŸŸåæ˜¯å¦åœ¨é¢„æœŸåˆ—è¡¨ä¸­
                if (expectedDomains.includes(currentDomain)) {
                    addDiagnostic(
                        'æˆæƒåŸŸååŒ¹é…',
                        'pass',
                        `å½“å‰åŸŸå "${currentDomain}" åœ¨é¢„æœŸçš„æˆæƒåŸŸååˆ—è¡¨ä¸­`
                    )
                } else {
                    addDiagnostic(
                        'æˆæƒåŸŸååŒ¹é…',
                        'fail',
                        `å½“å‰åŸŸå "${currentDomain}" ä¸åœ¨é¢„æœŸçš„æˆæƒåŸŸååˆ—è¡¨ä¸­`,
                        { 'å½“å‰åŸŸå': currentDomain, 'é¢„æœŸåŸŸå': expectedDomains }
                    )
                }

                // æä¾›Firebaseæ§åˆ¶å°é“¾æ¥å’Œè¯´æ˜
                const configHelp = {
                    'Firebaseæ§åˆ¶å°URL': `https://console.firebase.google.com/project/${firebaseConfig.projectId}/authentication/settings`,
                    'æˆæƒåŸŸåè®¾ç½®è·¯å¾„': 'Authentication â†’ Settings â†’ Authorized domains',
                    'éœ€è¦æ·»åŠ çš„åŸŸå': [
                        'localhost',
                        'å¦‚æœä½¿ç”¨è‡ªå®šä¹‰åŸŸåï¼Œè¯·æ·»åŠ æ‚¨çš„åŸŸå'
                    ],
                    'å½“å‰ä½¿ç”¨çš„åŸŸå': currentDomain,
                    'è¯´æ˜': 'ç¡®ä¿åœ¨Firebaseæ§åˆ¶å°çš„æˆæƒåŸŸååˆ—è¡¨ä¸­æ·»åŠ äº†å½“å‰ä½¿ç”¨çš„åŸŸå'
                }

                updateDetails({
                    'æˆæƒåŸŸåé…ç½®å¸®åŠ©': configHelp
                })

                // æ£€æŸ¥æ˜¯å¦å¯èƒ½çš„é…ç½®é—®é¢˜
                if (currentDomain === 'localhost') {
                    addDiagnostic(
                        'åŸŸåé…ç½®å»ºè®®',
                        'warning',
                        'è¯·ç¡®è®¤Firebaseæ§åˆ¶å°å·²æ·»åŠ  "localhost" åˆ°æˆæƒåŸŸååˆ—è¡¨ï¼ˆä¸è¦æ·»åŠ ç«¯å£å·ï¼‰'
                    )
                } else {
                    addDiagnostic(
                        'åŸŸåé…ç½®å»ºè®®',
                        'warning',
                        `è¯·ç¡®è®¤Firebaseæ§åˆ¶å°å·²æ·»åŠ  "${currentDomain}" åˆ°æˆæƒåŸŸååˆ—è¡¨`
                    )
                }

                updateStatus('âœ… æˆæƒåŸŸåæ£€æŸ¥å®Œæˆ', 'success')

            } catch (error) {
                addDiagnostic(
                    'æˆæƒåŸŸåæµ‹è¯•',
                    'fail',
                    `æˆæƒåŸŸåæµ‹è¯•å¤±è´¥: ${error.message}`,
                    error
                )
                updateStatus('âŒ æˆæƒåŸŸåæµ‹è¯•å¤±è´¥', 'error')
            }
        }

        // è¿è¡Œå®Œæ•´è¯Šæ–­
        window.runFullDiagnosis = async function() {
            try {
                updateStatus('ğŸ” å¼€å§‹è¿è¡Œå®Œæ•´è¯Šæ–­...', 'info')
                diagnosticResults = [] // æ¸…ç©ºä¹‹å‰çš„ç»“æœ

                // 1. åˆå§‹åŒ–Firebase
                const firebaseOk = initializeFirebase()
                if (!firebaseOk) return

                // 2. æ£€æŸ¥ç¯å¢ƒ
                const envDetails = checkEnvironment()

                // 3. æ£€æŸ¥Firebaseé¡¹ç›®é…ç½®
                const projectDetails = checkFirebaseProject()

                // 4. æ£€æŸ¥Firebaseè¿æ¥
                await checkFirebaseConnection()

                // 5. æµ‹è¯•æˆæƒåŸŸå
                await testAuthDomains()

                // æ±‡æ€»è¯¦ç»†ä¿¡æ¯
                const summary = {
                    'è¯Šæ–­æ—¶é—´': new Date().toLocaleString(),
                    'ç¯å¢ƒä¿¡æ¯': envDetails,
                    'Firebaseé¡¹ç›®é…ç½®': projectDetails,
                    'è¯Šæ–­ç»“æœæ•°é‡': diagnosticResults.length,
                    'é€šè¿‡æ£€æŸ¥': diagnosticResults.filter(r => r.status === 'pass').length,
                    'å¤±è´¥æ£€æŸ¥': diagnosticResults.filter(r => r.status === 'fail').length,
                    'è­¦å‘Šæ£€æŸ¥': diagnosticResults.filter(r => r.status === 'warning').length
                }

                updateDetails(summary)

                const failCount = diagnosticResults.filter(r => r.status === 'fail').length
                const warningCount = diagnosticResults.filter(r => r.status === 'warning').length

                if (failCount === 0 && warningCount === 0) {
                    updateStatus('ğŸ‰ æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼Firebaseé…ç½®æ­£ç¡®', 'success')
                } else if (failCount === 0) {
                    updateStatus(`âš ï¸ è¯Šæ–­å®Œæˆï¼Œæœ‰ ${warningCount} ä¸ªè­¦å‘Šéœ€è¦æ³¨æ„`, 'warning')
                } else {
                    updateStatus(`âŒ è¯Šæ–­å®Œæˆï¼Œæœ‰ ${failCount} ä¸ªé”™è¯¯å’Œ ${warningCount} ä¸ªè­¦å‘Š`, 'error')
                }

            } catch (error) {
                addDiagnostic(
                    'å®Œæ•´è¯Šæ–­',
                    'fail',
                    `è¯Šæ–­è¿‡ç¨‹å¤±è´¥: ${error.message}`,
                    error
                )
                updateStatus('âŒ è¯Šæ–­è¿‡ç¨‹å¤±è´¥', 'error')
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡ŒåŸºç¡€æ£€æŸ¥
        window.addEventListener('load', () => {
            setTimeout(runFullDiagnosis, 500)
        })
    </script>

    <div class="warning">
        <h3>ğŸš¨ æœ€å¯èƒ½çš„é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ:</h3>
        <ol>
            <li><strong>FirebaseæˆæƒåŸŸåæœªé…ç½®</strong>
                <ul>
                    <li>æ‰“å¼€ <a href="https://console.firebase.google.com/project/poem2guess-8d19f/authentication/settings" target="_blank">Firebaseæ§åˆ¶å°</a></li>
                    <li>è¿›å…¥ Authentication â†’ Settings â†’ Authorized domains</li>
                    <li>æ·»åŠ  <code>localhost</code> ï¼ˆä¸è¦åŠ ç«¯å£å·ï¼‰</li>
                </ul>
            </li>
            <li><strong>æµè§ˆå™¨å­˜å‚¨è¢«æ¸…é™¤</strong>
                <ul>
                    <li>redirectè®¤è¯ä¾èµ–æµè§ˆå™¨å­˜å‚¨æ¥ä¿æŒçŠ¶æ€</li>
                    <li>å¦‚æœå­˜å‚¨è¢«æ¸…é™¤ï¼Œè®¤è¯çŠ¶æ€ä¼šä¸¢å¤±</li>
                </ul>
            </li>
            <li><strong>ç½‘ç»œæˆ–æ—¶é—´é—®é¢˜</strong>
                <ul>
                    <li>redirectè®¤è¯éœ€è¦ä¸€å®šæ—¶é—´å®Œæˆ</li>
                    <li>ç½‘ç»œé—®é¢˜å¯èƒ½å¯¼è‡´è®¤è¯çŠ¶æ€ä¸¢å¤±</li>
                </ul>
            </li>
        </ol>
    </div>

    <div class="info">
        <h3>ğŸ”§ å¿«é€Ÿä¿®å¤æ­¥éª¤:</h3>
        <ol>
            <li>è¿è¡Œä¸Šé¢çš„"å®Œæ•´è¯Šæ–­"æŸ¥çœ‹å…·ä½“é—®é¢˜</li>
            <li>æ ¹æ®è¯Šæ–­ç»“æœä¿®å¤Firebaseé…ç½®</li>
            <li>è¿”å› <code>test-redirect-debug.html</code> é‡æ–°æµ‹è¯•</li>
            <li>å¦‚æœé—®é¢˜ä»ç„¶å­˜åœ¨ï¼Œä½¿ç”¨ä¸»åº”ç”¨çš„æ™ºèƒ½è®¤è¯ï¼ˆä¼šè‡ªåŠ¨å›é€€åˆ°popupæ¨¡å¼ï¼‰</li>
        </ol>
    </div>
</body>
</html> 