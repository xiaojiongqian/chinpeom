<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ— ç¬¬ä¸‰æ–¹Cookies Firebaseè®¤è¯æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
        }
        .success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .info {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        .warning {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .json-display {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .method-box {
            border: 2px solid #007bff;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        .method-title {
            font-weight: bold;
            color: #007bff;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <h1>ğŸª æ— ç¬¬ä¸‰æ–¹Cookies Firebaseè®¤è¯æµ‹è¯•</h1>
    
    <div class="warning">
        <strong>âš ï¸ Chromeç¬¬ä¸‰æ–¹Cookiesé—®é¢˜:</strong>
        <p>Chromeæ­£åœ¨é™åˆ¶ç¬¬ä¸‰æ–¹cookiesï¼Œè¿™å¯èƒ½å½±å“Firebaseå¼¹çª—è®¤è¯ã€‚æœ¬é¡µé¢æä¾›å¤šç§è§£å†³æ–¹æ¡ˆã€‚</p>
    </div>

    <div id="status" class="status info">å‡†å¤‡æµ‹è¯•ä¸åŒçš„è®¤è¯æ–¹æ³•...</div>

    <!-- æ–¹æ³•1: Redirectè®¤è¯ -->
    <div class="method-box">
        <div class="method-title">æ–¹æ³•1: Redirectè®¤è¯ (æ¨è)</div>
        <p>å®Œå…¨é¿å…ç¬¬ä¸‰æ–¹cookiesé—®é¢˜ï¼Œé€‚åˆæ‰€æœ‰æµè§ˆå™¨</p>
        <button onclick="testRedirectAuth()">ğŸ”„ æµ‹è¯•Redirectè®¤è¯</button>
        <button onclick="checkRedirectResult()">ğŸ” æ£€æŸ¥Redirectç»“æœ</button>
    </div>

    <!-- æ–¹æ³•2: Popupè®¤è¯ + å®½æ¾ç­–ç•¥ -->
    <div class="method-box">
        <div class="method-title">æ–¹æ³•2: Popupè®¤è¯ + å®½æ¾ç­–ç•¥</div>
        <p>é…ç½®Firebaseä½¿ç”¨æ›´å®½æ¾çš„cookieç­–ç•¥</p>
        <button onclick="testPopupAuthRelaxed()">ğŸªŸ æµ‹è¯•å®½æ¾Popupè®¤è¯</button>
    </div>

    <!-- æ–¹æ³•3: å†…åµŒiframeè®¤è¯ -->
    <div class="method-box">
        <div class="method-title">æ–¹æ³•3: è‡ªå®šä¹‰è®¤è¯æµç¨‹</div>
        <p>ç»•è¿‡Firebaseé»˜è®¤æµç¨‹ï¼Œä½¿ç”¨è‡ªå®šä¹‰Google OAuth2</p>
        <button onclick="testCustomAuth()">ğŸ› ï¸ æµ‹è¯•è‡ªå®šä¹‰è®¤è¯</button>
    </div>

    <!-- çŠ¶æ€æ˜¾ç¤º -->
    <div style="margin: 20px 0;">
        <button onclick="logout()">ğŸšª ç™»å‡ºæ‰€æœ‰</button>
        <button onclick="clearAllData()">ğŸ§¹ æ¸…ç©ºæ‰€æœ‰æ•°æ®</button>
        <button onclick="checkCookieSupport()">ğŸª æ£€æŸ¥Cookieæ”¯æŒ</button>
    </div>

    <div id="userInfo" class="json-display"></div>
    <div id="tokenInfo" class="json-display"></div>
    <div id="backendResponse" class="json-display"></div>
    <div id="debugInfo" class="json-display"></div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js'
        import { 
            getAuth, 
            GoogleAuthProvider, 
            signInWithPopup,
            signInWithRedirect,
            getRedirectResult,
            signOut 
        } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js'

        // Firebaseé…ç½®
        const firebaseConfig = {
            apiKey: "AIzaSyCHt0r0EgWVt7xhOZS_piykzBcTSjKexek",
            authDomain: "poem2guess-8d19f.firebaseapp.com",
            projectId: "poem2guess-8d19f",
            storageBucket: "poem2guess-8d19f.firebasestorage.app",
            messagingSenderId: "521053998371",
            appId: "1:521053998371:web:5a8c5e7b8ec4d8f75f5e5d"
        }

        // åˆå§‹åŒ–Firebase
        const app = initializeApp(firebaseConfig)
        const auth = getAuth(app)
        
        // é…ç½®Google Provider - å®½æ¾ç­–ç•¥
        const googleProvider = new GoogleAuthProvider()
        googleProvider.addScope('email')
        googleProvider.addScope('profile')
        
        // è®¾ç½®è‡ªå®šä¹‰å‚æ•°ï¼Œå°è¯•è§£å†³cookiesé—®é¢˜
        googleProvider.setCustomParameters({
            'prompt': 'select_account',
            'include_granted_scopes': 'true',
            'access_type': 'offline'
        })

        // çŠ¶æ€ç®¡ç†
        let isLoading = false

        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status')
            statusDiv.className = `status ${type}`
            statusDiv.textContent = message
        }

        function updateUserInfo(userInfo) {
            const userDiv = document.getElementById('userInfo')
            userDiv.innerHTML = '<h3>ğŸ‘¤ ç”¨æˆ·ä¿¡æ¯:</h3>' + JSON.stringify(userInfo, null, 2)
        }

        function updateTokenInfo(tokenInfo) {
            const tokenDiv = document.getElementById('tokenInfo')
            tokenDiv.innerHTML = '<h3>ğŸ”‘ Tokenä¿¡æ¯:</h3>' + JSON.stringify(tokenInfo, null, 2)
        }

        function updateBackendResponse(response) {
            const backendDiv = document.getElementById('backendResponse')
            backendDiv.innerHTML = '<h3>ğŸ”§ åç«¯å“åº”:</h3>' + JSON.stringify(response, null, 2)
        }

        function updateDebugInfo(info) {
            const debugDiv = document.getElementById('debugInfo')
            debugDiv.innerHTML = '<h3>ğŸ› è°ƒè¯•ä¿¡æ¯:</h3>' + JSON.stringify(info, null, 2)
        }

        // è®¾ç½®æŒ‰é’®çŠ¶æ€
        function setButtonsEnabled(enabled) {
            const buttons = document.querySelectorAll('button')
            buttons.forEach(btn => {
                btn.disabled = !enabled
            })
        }

        // æ–¹æ³•1: Redirectè®¤è¯
        window.testRedirectAuth = async function() {
            if (isLoading) return
            
            try {
                isLoading = true
                setButtonsEnabled(false)
                updateStatus('ğŸ”„ å¯åŠ¨Redirectè®¤è¯ï¼ˆå®Œå…¨é¿å…cookiesé—®é¢˜ï¼‰...', 'info')
                
                await signInWithRedirect(auth, googleProvider)
                
            } catch (error) {
                console.error('Redirectè®¤è¯å¤±è´¥:', error)
                updateStatus(`âŒ Redirectè®¤è¯å¤±è´¥: ${error.message}`, 'error')
                isLoading = false
                setButtonsEnabled(true)
            }
        }

        // æ£€æŸ¥redirectç»“æœ
        window.checkRedirectResult = async function() {
            if (isLoading) return
            
            try {
                isLoading = true
                setButtonsEnabled(false)
                updateStatus('ğŸ” æ£€æŸ¥Redirectè®¤è¯ç»“æœ...', 'info')
                
                const result = await getRedirectResult(auth)
                
                if (result) {
                    await handleAuthSuccess(result.user, 'ğŸ”„ Redirectè®¤è¯')
                } else {
                    updateStatus('â„¹ï¸ æ²¡æœ‰æ£€æµ‹åˆ°Redirectè®¤è¯ç»“æœ', 'info')
                }
                
            } catch (error) {
                console.error('æ£€æŸ¥Redirectç»“æœå¤±è´¥:', error)
                updateStatus(`âŒ æ£€æŸ¥Redirectç»“æœå¤±è´¥: ${error.message}`, 'error')
            } finally {
                isLoading = false
                setButtonsEnabled(true)
            }
        }

        // æ–¹æ³•2: å®½æ¾ç­–ç•¥Popupè®¤è¯
        window.testPopupAuthRelaxed = async function() {
            if (isLoading) return
            
            try {
                isLoading = true
                setButtonsEnabled(false)
                updateStatus('ğŸªŸ å°è¯•å®½æ¾ç­–ç•¥Popupè®¤è¯...', 'info')
                
                // å°è¯•æ‰“å¼€popupå‰å…ˆæ£€æŸ¥æ˜¯å¦å…è®¸
                const testWindow = window.open('', '_blank', 'width=1,height=1')
                if (!testWindow) {
                    throw new Error('æµè§ˆå™¨é˜»æ­¢äº†å¼¹çª—ï¼Œè¯·å…è®¸å¼¹çª—åé‡è¯•')
                }
                testWindow.close()
                
                const result = await signInWithPopup(auth, googleProvider)
                await handleAuthSuccess(result.user, 'ğŸªŸ å®½æ¾Popupè®¤è¯')
                
            } catch (error) {
                console.error('å®½æ¾Popupè®¤è¯å¤±è´¥:', error)
                let errorMessage = error.message
                
                if (error.code === 'auth/popup-blocked') {
                    errorMessage = 'å¼¹çª—è¢«é˜»æ­¢ï¼Œè¯·å…è®¸æ­¤ç½‘ç«™çš„å¼¹çª—'
                } else if (error.code === 'auth/popup-closed-by-user') {
                    errorMessage = 'ç”¨æˆ·å…³é—­äº†è®¤è¯å¼¹çª—'
                } else if (error.message.includes('Cross-Origin-Opener-Policy')) {
                    errorMessage = 'ç¬¬ä¸‰æ–¹Cookiesè¢«é˜»æ­¢ï¼Œå»ºè®®ä½¿ç”¨Redirectè®¤è¯'
                }
                
                updateStatus(`âŒ å®½æ¾Popupè®¤è¯å¤±è´¥: ${errorMessage}`, 'error')
                
                // å¦‚æœæ˜¯CORSé—®é¢˜ï¼Œå»ºè®®ä½¿ç”¨redirect
                if (error.message.includes('Cross-Origin') || error.message.includes('cookies')) {
                    updateStatus('ğŸ’¡ å»ºè®®ï¼šé‡åˆ°cookiesé—®é¢˜ï¼Œè¯·ä½¿ç”¨"Redirectè®¤è¯"æ–¹æ³•', 'warning')
                }
                
            } finally {
                isLoading = false
                setButtonsEnabled(true)
            }
        }

        // æ–¹æ³•3: è‡ªå®šä¹‰è®¤è¯æµç¨‹
        window.testCustomAuth = async function() {
            if (isLoading) return
            
            try {
                isLoading = true
                setButtonsEnabled(false)
                updateStatus('ğŸ› ï¸ å°è¯•è‡ªå®šä¹‰Google OAuth2è®¤è¯æµç¨‹...', 'info')
                
                // æ„å»ºGoogle OAuth2 URL
                const clientId = '521053998371-your-client-id-here.apps.googleusercontent.com' // éœ€è¦ä»Firebase Consoleè·å–
                const redirectUri = encodeURIComponent(window.location.origin + window.location.pathname)
                const scope = encodeURIComponent('openid email profile')
                const state = Math.random().toString(36).substring(2, 15)
                
                const authUrl = `https://accounts.google.com/o/oauth2/v2/auth?` +
                    `client_id=${clientId}&` +
                    `redirect_uri=${redirectUri}&` +
                    `scope=${scope}&` +
                    `response_type=code&` +
                    `state=${state}&` +
                    `include_granted_scopes=true&` +
                    `access_type=offline&` +
                    `prompt=select_account`
                
                updateStatus('ğŸš€ è‡ªå®šä¹‰è®¤è¯åŠŸèƒ½å¼€å‘ä¸­ï¼Œéœ€è¦é…ç½®OAuth2å®¢æˆ·ç«¯ID', 'warning')
                updateDebugInfo({
                    message: 'è‡ªå®šä¹‰è®¤è¯éœ€è¦ä»¥ä¸‹æ­¥éª¤',
                    steps: [
                        '1. åœ¨Google Cloud Consoleåˆ›å»ºOAuth2å®¢æˆ·ç«¯ID',
                        '2. é…ç½®æˆæƒçš„é‡å®šå‘URI',
                        '3. å®ç°authorization codeäº¤æ¢tokençš„åç«¯æ¥å£',
                        '4. ä½¿ç”¨è·å–çš„tokenéªŒè¯ç”¨æˆ·èº«ä»½'
                    ],
                    authUrl: authUrl
                })
                
            } catch (error) {
                console.error('è‡ªå®šä¹‰è®¤è¯å¤±è´¥:', error)
                updateStatus(`âŒ è‡ªå®šä¹‰è®¤è¯å¤±è´¥: ${error.message}`, 'error')
            } finally {
                isLoading = false
                setButtonsEnabled(true)
            }
        }

        // å¤„ç†è®¤è¯æˆåŠŸ
        async function handleAuthSuccess(user, method) {
            try {
                const idToken = await user.getIdToken()
                
                // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
                const userInfo = {
                    method: method,
                    uid: user.uid,
                    email: user.email,
                    displayName: user.displayName,
                    photoURL: user.photoURL,
                    emailVerified: user.emailVerified
                }
                updateUserInfo(userInfo)
                
                // æ˜¾ç¤ºTokenä¿¡æ¯
                const tokenInfo = {
                    idToken: idToken.substring(0, 50) + '...',
                    tokenLength: idToken.length,
                    method: method
                }
                updateTokenInfo(tokenInfo)
                
                updateStatus(`âœ… ${method}æˆåŠŸï¼æ­£åœ¨å‘é€åˆ°åç«¯éªŒè¯...`, 'success')
                
                // å‘é€åˆ°åç«¯éªŒè¯
                await testBackendAuth(idToken, user.uid, method)
                
            } catch (error) {
                console.error('å¤„ç†è®¤è¯æˆåŠŸå¤±è´¥:', error)
                updateStatus(`âŒ å¤„ç†è®¤è¯ç»“æœå¤±è´¥: ${error.message}`, 'error')
            }
        }

        // æµ‹è¯•åç«¯è®¤è¯
        async function testBackendAuth(idToken, firebaseUid, method) {
            try {
                updateStatus('ğŸ”§ æ­£åœ¨éªŒè¯åç«¯è®¤è¯...', 'info')
                
                const response = await fetch('http://localhost:3001/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        provider: 'google',
                        access_token: idToken,
                        firebase_uid: firebaseUid
                    })
                })

                const data = await response.json()
                
                if (response.ok) {
                    updateStatus(`âœ… ${method} + åç«¯è®¤è¯å…¨éƒ¨æˆåŠŸï¼ğŸ‰`, 'success')
                    updateBackendResponse({
                        method: method,
                        success: true,
                        ...data
                    })
                } else {
                    updateStatus(`âŒ ${method}æˆåŠŸï¼Œä½†åç«¯è®¤è¯å¤±è´¥: ${data.message}`, 'error')
                    updateBackendResponse({
                        method: method,
                        success: false,
                        ...data
                    })
                }
                
            } catch (error) {
                console.error('åç«¯è®¤è¯æµ‹è¯•å¤±è´¥:', error)
                updateStatus(`âŒ åç«¯è®¤è¯æµ‹è¯•å¤±è´¥: ${error.message}`, 'error')
                updateBackendResponse({
                    method: method,
                    success: false,
                    error: error.message
                })
            }
        }

        // æ£€æŸ¥Cookieæ”¯æŒ
        window.checkCookieSupport = function() {
            const testCookie = 'test_cookie=test_value; SameSite=None; Secure'
            document.cookie = testCookie
            
            const hasCookie = document.cookie.includes('test_cookie=test_value')
            
            // æ¸…ç†æµ‹è¯•cookie
            document.cookie = 'test_cookie=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;'
            
            const debugInfo = {
                userAgent: navigator.userAgent,
                cookieEnabled: navigator.cookieEnabled,
                testCookieWorked: hasCookie,
                currentCookies: document.cookie,
                isSecureContext: window.isSecureContext,
                location: window.location.protocol + '//' + window.location.host
            }
            
            updateDebugInfo(debugInfo)
            
            if (!navigator.cookieEnabled) {
                updateStatus('âŒ æµè§ˆå™¨ç¦ç”¨äº†Cookies', 'error')
            } else if (!window.isSecureContext) {
                updateStatus('âš ï¸ éHTTPSç¯å¢ƒï¼Œå¯èƒ½å½±å“æŸäº›è®¤è¯åŠŸèƒ½', 'warning')
            } else if (!hasCookie) {
                updateStatus('âš ï¸ ç¬¬ä¸‰æ–¹Cookieså¯èƒ½è¢«é˜»æ­¢ï¼Œå»ºè®®ä½¿ç”¨Redirectè®¤è¯', 'warning')
            } else {
                updateStatus('âœ… Cookieæ”¯æŒæ­£å¸¸', 'success')
            }
        }

        // ç™»å‡ºæ‰€æœ‰
        window.logout = async function() {
            try {
                await signOut(auth)
                
                // æ¸…ç©ºæ˜¾ç¤ºä¿¡æ¯
                document.getElementById('userInfo').innerHTML = ''
                document.getElementById('tokenInfo').innerHTML = ''
                document.getElementById('backendResponse').innerHTML = ''
                
                updateStatus('âœ… å·²ç™»å‡ºæ‰€æœ‰è®¤è¯', 'success')
                
            } catch (error) {
                console.error('ç™»å‡ºå¤±è´¥:', error)
                updateStatus(`âŒ ç™»å‡ºå¤±è´¥: ${error.message}`, 'error')
            }
        }

        // æ¸…ç©ºæ‰€æœ‰æ•°æ®
        window.clearAllData = function() {
            // æ¸…ç©ºlocalStorage
            localStorage.clear()
            
            // æ¸…ç©ºsessionStorage
            sessionStorage.clear()
            
            // æ¸…ç©ºæ˜¾ç¤ºå†…å®¹
            document.getElementById('userInfo').innerHTML = ''
            document.getElementById('tokenInfo').innerHTML = ''
            document.getElementById('backendResponse').innerHTML = ''
            document.getElementById('debugInfo').innerHTML = ''
            
            updateStatus('ğŸ§¹ å·²æ¸…ç©ºæ‰€æœ‰æœ¬åœ°æ•°æ®', 'info')
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥çŠ¶æ€
        window.addEventListener('load', () => {
            updateStatus('ğŸ“± é¡µé¢å·²åŠ è½½ï¼Œå¼€å§‹æ£€æŸ¥è®¤è¯çŠ¶æ€...', 'info')
            
            // è‡ªåŠ¨æ£€æŸ¥redirectç»“æœ
            checkRedirectResult()
            
            // æ£€æŸ¥cookieæ”¯æŒ
            setTimeout(checkCookieSupport, 1000)
        })

        // ç›‘å¬è®¤è¯çŠ¶æ€å˜åŒ–
        auth.onAuthStateChanged((user) => {
            if (user) {
                console.log('Firebaseè®¤è¯çŠ¶æ€: å·²ç™»å½•', user.displayName || user.email)
            } else {
                console.log('Firebaseè®¤è¯çŠ¶æ€: æœªç™»å½•')
            }
        })
    </script>

    <div class="info">
        <h3>ğŸ“‹ ä½¿ç”¨è¯´æ˜:</h3>
        <ol>
            <li><strong>æ¨èæ–¹æ³•</strong>: ä½¿ç”¨"Redirectè®¤è¯"ï¼Œå®Œå…¨é¿å…ç¬¬ä¸‰æ–¹cookiesé—®é¢˜</li>
            <li><strong>å¤‡ç”¨æ–¹æ³•</strong>: å¦‚æœéœ€è¦ä¿æŒé¡µé¢çŠ¶æ€ï¼Œå…ˆå°è¯•"å®½æ¾Popupè®¤è¯"</li>
            <li><strong>å¼€å‘æ–¹æ³•</strong>: "è‡ªå®šä¹‰è®¤è¯"éœ€è¦é¢å¤–é…ç½®ï¼Œé€‚åˆé«˜çº§å®šåˆ¶éœ€æ±‚</li>
            <li>ç‚¹å‡»"æ£€æŸ¥Cookieæ”¯æŒ"äº†è§£å½“å‰æµè§ˆå™¨çš„cookiesç­–ç•¥</li>
        </ol>
    </div>

    <div class="warning">
        <h3>ğŸ”§ æ•…éšœæ’é™¤:</h3>
        <ul>
            <li><strong>CORSé”™è¯¯</strong>: ä½¿ç”¨Redirectè®¤è¯æ–¹æ³•</li>
            <li><strong>å¼¹çª—è¢«é˜»æ­¢</strong>: å…è®¸æ­¤ç½‘ç«™çš„å¼¹çª—ï¼Œæˆ–ä½¿ç”¨Redirectè®¤è¯</li>
            <li><strong>åç«¯éªŒè¯å¤±è´¥</strong>: æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦è¿è¡Œåœ¨ http://localhost:3001</li>
            <li><strong>ç¬¬ä¸‰æ–¹Cookiesè¢«é˜»æ­¢</strong>: Chromeè®¾ç½® â†’ éšç§å’Œå®‰å…¨ â†’ Cookies â†’ å…è®¸ç¬¬ä¸‰æ–¹cookies</li>
        </ul>
    </div>
</body>
</html> 