# 测试数据自动清理机制

## 概述

为了确保测试环境的干净和可重复性，我们实现了完整的测试数据自动清理机制。该机制包含以下几个部分：

1. **自动数据跟踪**：测试过程中自动跟踪创建的用户和订单
2. **自动清理**：测试完成后自动清理测试数据
3. **手动清理**：提供手动清理脚本
4. **安全保护**：确保只能操作测试数据库

## 功能特性

### ✅ 自动数据跟踪
- 自动跟踪测试创建的用户ID
- 自动跟踪测试创建的订单号
- 自动跟踪第三方账号绑定

### ✅ 多层级清理机制
- **测试后清理**：每个测试用例完成后清理当前测试数据
- **套件后清理**：整个测试套件完成后进行全量清理
- **手动清理**：提供独立脚本进行手动清理

### ✅ 安全保护
- 数据库名必须包含 "test" 才能执行清理
- 使用独立的测试数据库
- 事务保护，确保数据一致性

## 使用方法

### 1. 环境配置

复制并配置测试环境变量：

```bash
# 在 server 目录下
cp env.test.example .env.test
```

编辑 `.env.test` 文件，配置测试数据库：

```env
DB_HOST=localhost
DB_PORT=3306
DB_USER=root
DB_PASSWORD=your_password
DB_NAME=poem2ndguess_test  # 必须包含 "test"
```

### 2. 运行测试

```bash
# 运行测试（会自动清理）
npm test

# 运行测试并在最后手动清理
npm run test:run-with-cleanup

# 持续测试模式
npm run test:watch
```

### 3. 手动清理

```bash
# 查看当前测试数据
npm run test:clean-info

# 清理所有测试数据
npm run test:clean

# 或直接运行脚本
node scripts/cleanTestData.js info
node scripts/cleanTestData.js clean
```

## 工作原理

### 数据跟踪机制

```javascript
// 在测试中自动跟踪用户
test('用户登录', async () => {
  const response = await request(app)
    .post('/api/auth/login')
    .send({ provider: 'wechat', access_token: 'test_token' })
  
  const userId = response.body.user.id
  
  // 自动跟踪测试用户（由setup.js自动调用）
  global.trackTestUser(userId)
})
```

### 清理时机

1. **afterEach**：每个测试用例后清理当前测试创建的数据
2. **afterAll**：测试套件结束后进行全量清理
3. **手动触发**：使用清理脚本手动清理

### 清理顺序

清理按照以下顺序进行，确保外键约束：

1. 支付记录 (payment_records)
2. 第三方账号绑定 (third_party_accounts)  
3. 用户数据 (users)

## 技术实现

### 核心组件

```
server/test/helpers/
├── testDbHelper.js          # 测试数据库帮助工具
│
server/test/
├── setup.js                 # 测试环境设置和清理钩子
│
server/scripts/
├── cleanTestData.js         # 手动清理脚本
│
server/
├── env.test.example         # 测试环境变量示例
```

### TestDatabaseHelper 类

主要功能：
- `setup()`: 初始化数据库连接
- `trackUser(userId)`: 跟踪用户ID
- `trackOrder(orderNo)`: 跟踪订单号
- `cleanupTestData()`: 清理当前测试数据
- `cleanupAllTestData()`: 全量清理测试数据
- `teardown()`: 关闭数据库连接

## 最佳实践

### 1. 测试编写规范

```javascript
test('用户注册测试', async () => {
  const response = await request(app)
    .post('/api/auth/login')
    .send(testData)
  
  const userId = response.body.user.id
  
  // ✅ 好的做法：自动跟踪测试用户
  if (global.trackTestUser) {
    global.trackTestUser(userId)
  }
  
  // 其他测试逻辑...
})
```

### 2. 数据隔离

- 每个测试使用唯一的测试标识
- 避免硬编码用户ID或订单号
- 使用随机生成的测试数据

### 3. 错误处理

```javascript
afterEach(async () => {
  try {
    if (testDbHelper.isSetup) {
      await testDbHelper.cleanupTestData()
    }
  } catch (error) {
    console.error('清理失败:', error.message)
    // 不阻断测试流程
  }
})
```

## 监控和调试

### 查看测试数据统计

```bash
# 查看当前测试数据概况
npm run test:clean-info
```

输出示例：
```
📋 测试数据详情:

👥 找到 5 个测试用户:
   ID: 123, 名称: 微信用户测试, 积分: 0, 创建时间: 2024-01-01 10:00:00
   ID: 124, 名称: Google User, 积分: 30, 创建时间: 2024-01-01 10:01:00
   ...
```

### 清理日志

清理过程会输出详细日志：

```
[测试数据库] 跟踪用户: 123
[测试数据库] 跟踪订单: ORD-20240101-001
[测试数据库] 清理了 3 条支付记录
[测试数据库] 清理了第三方账号绑定
[测试数据库] 清理了 2 个用户
[测试数据库] 数据清理完成
```

## 故障排除

### 常见问题

1. **数据库连接失败**
   ```
   [测试数据库] 连接失败: Access denied for user
   ```
   - 检查 `.env.test` 文件配置
   - 确保数据库用户有足够权限

2. **清理权限不足**
   ```
   ❌ 错误: 只能清理测试数据库
   ```
   - 确保数据库名包含 "test"
   - 检查环境变量配置

3. **外键约束错误**
   ```
   清理失败: Cannot delete or update a parent row
   ```
   - 清理顺序问题，检查清理逻辑
   - 可能存在数据依赖关系

### 调试技巧

1. **保留测试数据进行调试**
   ```env
   # 在 .env.test 中设置
   KEEP_TEST_DATA=true
   ```

2. **手动检查数据库状态**
   ```sql
   -- 检查测试用户
   SELECT * FROM users WHERE display_name LIKE '%测试%';
   
   -- 检查第三方账号
   SELECT * FROM third_party_accounts;
   
   -- 检查支付记录
   SELECT * FROM payment_records;
   ```

## 扩展功能

### 自定义清理策略

可以扩展 `TestDatabaseHelper` 类来支持更多清理策略：

```javascript
// 按时间范围清理
async cleanupByTimeRange(startTime, endTime) {
  // 实现逻辑...
}

// 按测试标签清理
async cleanupByTag(tag) {
  // 实现逻辑...
}
```

### 集成CI/CD

在CI/CD管道中使用：

```yaml
# GitHub Actions 示例
- name: Run Tests with Cleanup
  run: |
    cd server
    npm run test:run-with-cleanup
```

## 总结

测试数据自动清理机制确保了：

- ✅ **测试环境干净**：每次测试都从干净状态开始
- ✅ **数据隔离**：测试之间不会相互影响
- ✅ **安全保护**：只能操作测试数据库
- ✅ **操作便捷**：自动化清理，也支持手动操作
- ✅ **调试友好**：提供详细日志和状态查询

这套机制大大提高了测试的可靠性和维护性，确保测试结果的一致性和可重复性。 