# 唐诗译境项目测试环境与日志说明

## 测试环境配置

### 主要修改

1. 修改了`poemTranslation.ts`中的`loadPoemData`函数，确保在测试环境中能够正确处理静态资源，并在请求失败时返回默认测试数据而不是抛出错误。

2. 在`tests/setup.ts`中添加了用户API的模拟实现，用于替代真实的API调用：
   - 模拟了所有用户相关的API调用（注册、登录、获取用户信息等）
   - 返回合理的模拟数据，确保测试可以正常进行

3. 删除了`tests/utils/api.test.ts`中对真实API的测试，改为测试我们的模拟实现是否正常工作。

4. 添加了`tests/services/api.spec.ts`专门用于测试用户API的模拟实现。

5. 添加了`cross-env`依赖，并修改测试脚本，确保测试环境变量`NODE_ENV=test`被正确设置。

### 测试策略

1. **静态资源获取**：
   - 诗歌数据从静态资源获取，不依赖API
   - 在测试环境中，如果静态资源不可用，返回模拟数据

2. **用户API模拟**：
   - 用户相关的API调用被模拟实现替代
   - 模拟实现返回固定数据，确保测试结果一致

## 新增测试日志功能

为解决单元测试问题，本项目新增了丰富的诊断日志和追踪功能。

### 增强的日志记录

- 在关键文件中添加了详细的日志记录，包括加载过程、网络请求细节、错误处理等
- 所有日志使用一致的前缀格式，如 `[PoemTranslation]`、`[FileLoader]` 等，便于过滤和搜索
- 每个操作步骤都有清晰的日志记录，包括开始、进行中和完成状态

### 专门的测试运行器

- 新增 `tests/poemTest.mjs` 文件，专门用于运行诗歌相关测试
- 会自动创建日志文件，记录测试过程中的所有输出
- 能够分析测试失败原因，并提供简明摘要

### 模拟环境增强

- 改进了 `fetch` 模拟实现，增加调用计数和详细日志
- 提供了模拟数据访问的全局对象，便于不同测试文件共享数据
- 添加了错误堆栈追踪功能，便于定位问题

## 使用方法

### 运行标准测试

```bash
# 运行所有测试
npm run test:run

# 运行特定测试文件
npm run test:run tests/services/api.spec.ts

# 生成测试覆盖率报告
npm run test:coverage
```

### 运行诗歌功能测试

```bash
npm run test:poem
```

这个命令会执行以下操作：
1. 运行与诗歌功能相关的测试文件
2. 在 `test-logs` 目录下生成日志文件
3. 显示测试结果摘要

### 查看日志文件

测试日志保存在 `test-logs` 目录下，文件名格式为 `poem-test-{timestamp}.log`。

日志文件包含以下内容：
- 标准输出信息
- 错误输出信息
- 所有测试过程中生成的日志

## 分析常见问题

### 网络请求问题

- 查找 `[FileLoader]` 前缀的日志，了解 fetch 请求详情
- 检查请求 URL、响应状态和数据格式

### 数据加载问题

- 查找 `[PoemTranslation]` 前缀的日志，了解诗歌数据加载过程
- 检查是否成功加载数据，以及数据格式是否符合预期

### 组件渲染问题

- 查找 `[PoemDisplay.test]` 前缀的日志，了解组件挂载和渲染过程
- 检查组件状态变化和断言失败的具体原因

### API模拟问题

- 查找 `[测试设置]` 前缀的日志，了解API模拟设置情况
- 检查模拟API的调用参数和返回结果

## 最佳实践

1. **每次只关注一个具体问题**
   - 使用 `vitest --name "测试名称"` 运行特定测试用例
   - 或修改 `poemTest.mjs` 文件，只运行特定测试文件

2. **对比成功和失败的日志**
   - 保存成功和失败的测试日志，进行对比分析
   - 找出关键差异点，定位问题根源

3. **增量修复问题**
   - 先解决基础的网络请求和数据加载问题
   - 再解决组件渲染和交互问题
   - 最后解决复杂的异步操作问题

## 注意事项

1. 不要依赖真实的API调用，可能导致测试不稳定
2. 如果需要添加新的API，请同时在测试环境中添加相应的模拟实现
3. 定期清理测试日志文件，避免占用过多磁盘空间
4. 在提交代码前运行完整测试套件，确保所有测试通过 