# 唐诗译境(Chinpoem) 日志管理指南

## 概述

本项目实现了完整的日志管理系统，包含前端日志管理、后端API日志记录、自动清理机制等功能，确保日志不会过度增长并提供良好的调试体验。

## 🎯 主要特性

### ✅ 分级日志管理
- **前端日志**: 根据环境自动调整日志级别
- **后端日志**: API调用日志记录与轮转
- **测试日志**: 独立的测试日志管理

### ✅ 自动清理机制
- **文件轮转**: 单个文件超过10MB自动轮转
- **定期清理**: 自动删除7天前的日志文件
- **大小限制**: 总日志大小超过限制时自动清理最旧文件

### ✅ 环境适配
- **开发环境**: 详细的调试日志
- **测试环境**: 中等级别的日志
- **生产环境**: 仅显示错误日志

## 📂 日志文件结构

```
server/logs/
├── api-2025-06-02.log              # 当日API日志
├── api-2025-06-01.log              # 历史API日志
├── api-2025-06-02.2025-06-02T10-30-00-000Z.log  # 轮转的备份文件
└── poem-test-2025-06-02T10-30-00-000Z.log        # 测试日志
```

## 🔧 配置说明

### 后端日志配置

位置: `server/middleware/apiLogger.js`

```javascript
const LOG_CONFIG = {
  maxFileSize: 10 * 1024 * 1024, // 10MB - 单个文件最大大小
  maxFiles: 7,                    // 保留7天的日志
  logLevel: process.env.NODE_ENV === 'production' ? 'error' : 'info'
}
```

### 前端日志配置

位置: `src/utils/logger.ts`

```typescript
// 根据环境自动设置
this.config = {
  level: isDevelopment ? 'debug' : isTest ? 'warn' : 'error',
  enableConsole: isDevelopment || isTest,
  enableLocalStorage: isDevelopment,
  maxStoredLogs: 100
}
```

## 📝 使用方法

### 1. 前端日志使用

#### 基本用法
```typescript
import logger from '@/utils/logger'

// 不同级别的日志
logger.debug('调试信息', { userId: 123 })
logger.info('用户登录成功', { username: 'test' })
logger.warn('配置项缺失', { configKey: 'apiUrl' })
logger.error('API请求失败', error)
```

#### 兼容原有代码
```typescript
import { log, warn, error, debug } from '@/utils/logger'

log('这是信息日志')
warn('这是警告日志')
error('这是错误日志')
debug('这是调试日志')
```

#### 开发环境调试
在开发环境中，logger会暴露到全局window对象：

```javascript
// 浏览器控制台中
logger.setLevel('debug')        // 设置日志级别
logger.clearLogs()             // 清理存储的日志
logger.exportLogs()            // 导出日志用于调试
logger.getConfig()             // 查看当前配置
```

### 2. 后端日志监控

#### Web监控面板
访问: `http://localhost:3001/monitor`

功能包括:
- 📊 实时API统计
- 📝 最近50条API调用日志
- 🗑️ 日志清理功能
- 📋 日志文件信息查看

#### API接口监控
```bash
# 获取系统状态
curl http://localhost:3001/api/monitor/status

# 获取API调用日志
curl http://localhost:3001/api/monitor/logs?limit=20

# 获取日志文件信息
curl http://localhost:3001/api/monitor/logs/info

# 清理日志
curl -X DELETE "http://localhost:3001/api/monitor/logs?type=today"
curl -X DELETE "http://localhost:3001/api/monitor/logs?type=old" 
curl -X DELETE "http://localhost:3001/api/monitor/logs?type=all"
```

### 3. 命令行日志管理

#### 查看日志统计
```bash
npm run logs:stats
```

#### 执行日志清理
```bash
npm run logs:cleanup        # 常规清理
npm run logs:test-cleanup   # 测试模式（更严格）
npm run logs:help          # 查看帮助
```

#### 直接运行脚本
```bash
# 查看日志统计
node server/scripts/logCleanup.js stats

# 执行清理
node server/scripts/logCleanup.js cleanup

# 测试模式清理
node server/scripts/logCleanup.js test-cleanup
```

## 🎮 日志级别说明

### 前端日志级别
- **debug**: 详细的调试信息，仅开发环境显示
- **info**: 一般信息，开发和测试环境显示
- **warn**: 警告信息，所有环境显示
- **error**: 错误信息，所有环境显示
- **off**: 关闭所有日志

### 后端日志策略
- **开发环境**: 显示所有API调用
- **生产环境**: 仅记录错误请求到文件，控制台只显示错误
- **监控端点**: 不记录到文件（避免频繁的监控请求污染日志）

## 🧹 自动清理机制

### 1. 文件轮转
- 单个日志文件超过10MB时自动轮转
- 轮转后的文件添加时间戳标识
- 原文件重新开始记录

### 2. 定期清理
- 每小时自动运行一次清理任务
- 删除7天前的API日志文件
- 删除1天前的测试日志文件
- 服务器启动时执行一次清理

### 3. 大小限制
- 总日志大小超过200MB时触发清理
- 按文件修改时间排序，删除最旧的文件
- 单个文件超过50MB直接删除

### 4. 手动清理选项
- **today**: 仅清理今日日志
- **old**: 清理过期日志（保留规则内的文件）
- **all**: 清理所有日志文件

## 🚨 监控和告警

### 1. 日志文件监控
- 监控日志文件总大小
- 监控日志文件数量
- 监控清理操作结果

### 2. 性能监控
- API响应时间统计
- 错误率统计
- 请求频率统计

### 3. 异常检测
- 日志写入失败检测
- 磁盘空间不足检测
- 清理操作失败检测

## 📋 最佳实践

### 1. 日志记录规范

#### 前端日志
```typescript
// ✅ 推荐：带上下文信息
logger.info('用户操作完成', { 
  action: 'poem-guess', 
  result: 'correct',
  userId: user.id 
})

// ❌ 避免：无意义的日志
logger.debug('进入函数')
```

#### 后端日志
```javascript
// ✅ 推荐：结构化日志信息
console.log('[Auth] 用户登录成功', { 
  userId: user.id, 
  provider: 'wechat',
  ip: req.ip 
})

// ❌ 避免：敏感信息
console.log('用户密码:', password) // 危险！
```

### 2. 环境配置
```bash
# 生产环境变量
NODE_ENV=production

# 开发环境变量  
NODE_ENV=development
DEBUG=true
```

### 3. 定期维护
```bash
# 建议每周运行一次
npm run logs:cleanup

# 检查日志状态
npm run logs:stats
```

## 🔍 故障排除

### 常见问题

#### 1. 日志文件过大
```bash
# 检查日志状态
npm run logs:stats

# 强制清理
npm run logs:test-cleanup
```

#### 2. 磁盘空间不足
```bash
# 清理所有日志
curl -X DELETE "http://localhost:3001/api/monitor/logs?type=all"

# 或使用命令行
node server/scripts/logCleanup.js test-cleanup
```

#### 3. 前端日志过多
```javascript
// 浏览器控制台中临时调整
logger.setLevel('error')  // 只显示错误
logger.setConsoleOutput(false)  // 关闭控制台输出
```

#### 4. 后端日志丢失
检查日志目录权限：
```bash
ls -la server/logs/
chmod 755 server/logs/
```

### 调试技巧

#### 1. 临时启用详细日志
```javascript
// 前端 - 浏览器控制台
logger.setLevel('debug')

// 后端 - 环境变量
DEBUG=true npm run server
```

#### 2. 导出日志用于分析
```javascript
// 前端日志导出
const logs = logger.exportLogs()
console.log(logs)

// 后端日志查看
curl http://localhost:3001/api/monitor/logs?limit=100
```

## 📈 性能影响

### 日志记录开销
- **前端**: 开发环境约2-5ms延迟，生产环境忽略不计
- **后端**: 每个API请求增加1-3ms处理时间
- **存储**: 平均每天API日志约10-50MB（取决于访问量）

### 优化建议
1. 生产环境使用`error`级别日志
2. 避免记录大量无用的调试信息
3. 定期清理日志文件
4. 监控磁盘使用情况

## 🔮 未来改进

### 计划中的功能
1. **日志压缩**: 自动压缩历史日志文件
2. **远程日志**: 支持发送日志到远程服务器
3. **日志分析**: 内置日志分析和可视化
4. **告警通知**: 错误日志自动告警机制

### 扩展建议
1. 集成ELK stack（Elasticsearch + Logstash + Kibana）
2. 使用Redis缓存热点日志数据
3. 实现日志数据的实时流处理
4. 添加日志数据的业务分析功能

## 📚 相关文档

- [API监控使用指南](./API监控使用指南.md)
- [测试数据管理](./测试数据管理.md)
- [部署指南](./部署指南.md)

---

通过这套完整的日志管理系统，我们确保了：
- ✅ **日志不会无限增长**：自动清理和轮转机制
- ✅ **开发调试友好**：详细的开发环境日志
- ✅ **生产环境高效**：最小化的日志开销
- ✅ **问题快速定位**：结构化的日志信息
- ✅ **系统状态透明**：完整的监控和统计功能 