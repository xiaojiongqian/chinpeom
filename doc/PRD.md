# 需求描述
一个关于唐诗和外语混搭学习的Web应用,名"唐诗译境/Chinpoem", 使用Capacitor打包成APP

## 功能描述
1. 用户通过第三方账号（苹果、Google、Twitter/X）登录，登录后可记录学习得分
   - 支持单点登录(SSO)：若用户在浏览器中已登录第三方账号，应用可自动检测并提供一键登录，无需重复认证
   - 用户场景：用户在Gmail、YouTube等Google服务已登录，访问唐诗译境时自动显示"继续使用 [用户名@gmail.com]" 选项，点击即可完成登录
2. 随机显示一首唐诗及其配图，某一句会抽出显示其它语言（如英语）
3. 根据其它语言的提示，在备选答案中选择正确的诗句
4. 备选答案除了正确答案外，根据一定的算法，随机在其它的相近长度的诗句提取，作为干扰
5. 登录用户记录得分，若正确，则得分+1(简单模式)或+2(困难模式), 若错误则得分-1(简单模式)或-2(困难模式)
6. 根据得分获得古代学级称号（白丁、学童... 状元）
7. 设置界面,可以设置不同难度模式和界面语言。支持中文、英语、西班牙语、日语、法语、德语6种语言
   - 中文模式特殊性：选择中文时，界面语言为中文，提示语言为"none"，仅支持困难模式
   - 中文模式下用户仍可看到简单/困难模式选择器，但简单模式不可选择（置灰状态）
   - 非中文语言下，用户可在简单/困难模式间自由切换
   - 默认语言检测：检测到中文浏览器时，默认进入中文模式+困难模式
8. 后台支持可观测性，包括日志、指标、追踪等，使用Firebase Analytics进行用户行为分析和关键动作埋点
 
## 界面要求
登录界面：
- 登录，可以苹果账号、Google账号、Twitter/X账号登录
- 支持智能登录检测：如检测到用户浏览器已有第三方账号登录状态，显示"继续使用 [账号名称]" 快捷登录选项
- 游戏介绍，"猜一猜句子，学唐诗"
- 背景音乐按钮（默认打开），可以打开或关闭背景音乐，状态与主界面同步

主界面：
- 诗歌标题和作者
- 诗歌内容，其中一句被外文替代（简单模式--非中文语言首次进入默认简单模式），或星号行（困难模式）
- 4个选项，其中1个是正确答案，3个是类似长度的干扰项
- 当前诗句的配图
- 当前得分，古代学级称号
- 下一首按钮，表示下一首诗，点击后显示下一首诗
- 背景音乐开关按钮，控制背景音乐播放/暂停
- 背景音乐切换按钮，切换到下一首背景音乐
- 注：暂时不使用音效功能，所有音频控制均针对背景音乐
- 底部3个tab，分别导航到主界面、成就和设置界面

设置界面：
- 若已登录
  * 可账号退出
- 登录或未登录
  * 设置简单/困难模式
    - 中文模式下：简单模式选项置灰不可选，只能选择困难模式
    - 其他语言下：可在简单/困难模式间自由切换
  * 设置语言（中文（仅困难模式）、英语、西班牙语、日语、法语、德语）
    - 复用现有的语言选择器设计，中文选项显示为"中文（仅困难模式）"进行特殊标注
    - 从其他语言模式切换到中文时，无需弹出提示，系统自动切换到困难模式
- 底部3个tab，分别导航到主界面、成就和设置界面

成就界面：
- 显示当前用户得分和古代学级称号
- 展示学级进度和下一等级所需分数
- 等级称号说明和介绍
- 未付费用户可学习至学童（25分），达到25分时显示学童并立即弹出付费提示
- 25分时若不付费则无法继续答题，付费后保持当前分数可继续学习
- 从学童升级至秀才时需付费，付费解锁后用户可无限制学习
- 付费用户当前主要功能为移除分数上限，后续将补充更多功能
- 底部3个tab，分别导航到主界面、成就和设置界面
  
## 技术描述
1. 使用Vue3开发, 使用Vite构建,使用TailwindCSS进行样式管理
2. 使用Capacitor打包成APP
3. 使用Pinia管理状态
4. 使用VueRouter管理路由
5. 使用VueI18n管理国际化，支持中文、英语、西班牙语、日语、法语、德语六种语言。特别地，中文模式下无外语提示，仅支持困难模式
6. 采用本地存储模式：
   - 核心诗歌数据作为静态资源打包在应用中，确保离线状态下可使用全部功能
   - 用户数据（得分、设置等）使用localStorage本地存储
   - 离线答题：得分缓存在本地，联网后自动同步到服务器
   - 数据一致性：同步失败时以本地为准，但发现异常时以数据库为准
7. 数据库设计（MySQL）：
   - 4个核心表：users（用户信息）、third_party_accounts（第三方登录）、academic_ranks（学级配置）、payment_records（付费记录）
   - 积分采用本地缓存+定期同步策略，数据库只存储积分结果，不记录过程
   - 支持第三方登录账号绑定，免费用户最高升级至学童
   - 付费状态同步：联网时本地存储与数据库同步，换设备时通过数据库恢复付费状态
   - 单点登录实现：通过Firebase Auth状态监听和Token验证实现跨会话登录状态共享
8. 服务端功能：
   - 使用Express.js实现轻量级REST API，提供用户账户管理和积分同步功能
   - 应用部署采用两种模式：
     * Web版本：前端静态资源与后端API部署在同一服务器
     * 移动应用版本：前端打包进应用，通过网络请求连接远程API服务器
9. 可观测性与数据分析：
   - 集成Firebase Analytics进行用户行为追踪和数据分析
   - 关键埋点包括：用户登录、答题正确率、难度切换、语言切换、付费转化等
   - 支持实时监控和历史数据分析，为产品优化提供数据支持
   - 注重用户隐私保护，遵循GDPR等相关法规
10. 多语言架构：
    - 统一语言设置：界面语言与诗歌提示语言使用同一个语言选择器，无需分离
    - 默认界面语言根据用户浏览器/设备语言自动检测
    - 特殊处理中文模式：设置为中文时无外语提示，自动进入困难模式
    - 困难模式下保持界面语言设置，但诗歌提示显示为星号
    - 所有UI文本、提示信息、错误信息等均支持六种语言本地化

## 资源描述
1. public/resource/data/ 文件夹中内置了唐诗约300首，以不同语言存放在不同JSON文件中，文件名称为poem_chinese.json, poem_english.json, poem_french.json, poem_german.json, poem_japanese.json, poem_spanish.json，这些文件结构相同。
   - 中文模式：仅使用poem_chinese.json，因为中文模式无外语提示
   - 其他语言模式：以poem_chinese.json为主体内容，对应语言的JSON文件提供翻译提示
2. public/resource/poem_images/ 文件夹中内置了唐诗约300首唐诗的配图，配图名字对应JSON中的id
3. public/resource/sound/ 文件夹中内置了游戏音效（暂时不使用）
4. public/backgroundmusic/ 文件夹中内置了游戏背景音乐，可随机播放

## 数据结构
1. 用户数据（本地存储），包含用户名, 得分, 古代学级称号, 语言设置, 难度模式
   - 语言设置同时控制界面语言和诗歌提示语言
   - 中文模式下内部提示语言字段存储为"none"，难度模式固定为"hard"
2. 诗歌资源JSON格式例子：
    {
        "id": "927908c0-999f-4d3f-8192-d67d28f93576",
        "title": "八阵图",
        "author": "杜甫",
        "sentence": [
            {
                "senid": 0,
                "content": "功盖三分国"
            },
            {
                "senid": 1,
                "content": "名高八阵图"
            },
            {
                "senid": 2,
                "content": "江流石不转"
            },
            {
                "senid": 3,
                "content": "遗恨失吞吴"
            }
        ]
    }
3. 古代学级称号对应得分：
-白丁：0-10分  
-学童：11-25分  
-秀才：26-45分  
-廪生：46-70分  
-贡生：71-100分  
-举人：101-135分  
-贡士：136-175分  
-进士：176-220分  
-探花：221-280分  
-榜眼：281-340分  
-状元：341分以上

## 技术实现要点

### 第三方登录
- Apple Sign-In、Google OAuth、Twitter/X API集成
- 单点登录(SSO)功能：
  * 检测浏览器第三方账号登录状态
  * 提供静默认证(Silent Authentication)选项
  * 支持一键登录，优化用户体验
  * 处理账号状态变更和会话过期场景

### Firebase集成
- Analytics：用户行为分析（登录、答题、语言切换、付费转化等关键埋点）
- Performance：应用性能监控
- Crashlytics：错误追踪

### 多语言实现
- Vue I18n管理界面国际化，支持6种语言（中文、英语、西班牙语、日语、法语、德语）
- 统一语言设置：界面语言与诗歌提示语言使用同一个语言选择器
- 中文特殊逻辑：
  * 选择中文时无外语提示，仅支持困难模式
  * 中文模式下游戏逻辑：显示诗歌内容，某一句用星号替代，然后4选1猜测原句
  * 简单模式选项置灰不可选，但用户仍可看到模式选择器
  * 提示语言字段存储为"none"
- 自动检测用户设备语言作为默认值，检测到中文浏览器时默认进入中文模式+困难模式
- 语言切换时无需额外提示，系统自动处理模式切换
