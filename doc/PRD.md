# 需求描述
一个关于唐诗和外语混搭学习的Web应用,名"唐诗译境/Chinpoem", 使用Capacitor打包成APP。当前版本取消自建服务端，应用通过本地资源与可选的第三方云服务（如LLM接口）运行。

## 功能描述
1. 终端本地账户管理：随附一个终端工具，支持创建、删除、列出和切换本地账户。
   - 用户在终端输入账户名后即可创建账户文件，无需任何网络登录流程。
   - 当前选定账户信息写入公共配置文件，前端启动时读取该信息，自动加载对应学习进度。
   - 账户文件采用JSON格式长期保存在用户机器上（默认路径：`~/.chinpoem/accounts/<account>.json`），包含得分、学级、语言偏好、难度模式、上次更新时间等字段。
2. 随机显示一首唐诗及其配图，某一句会抽出显示其它语言（如英语）
3. 根据其它语言的提示，在备选答案中选择正确的诗句
4. 备选答案除了正确答案外，根据一定的算法，随机在其它的相近长度的诗句提取，作为干扰
5. 当前本地账户记录得分，若正确，则得分+1(简单模式)或+2(困难模式), 若错误则得分-1(简单模式)或-2(困难模式)
6. 根据得分获得古代学级称号（白丁、学童... 状元）
7. 设置界面,可以设置不同难度模式和界面语言。支持中文、英语、西班牙语、日语、法语、德语6种语言
   - 中文版特殊性：选择中文时，界面语言为中文，简单模式提示语言为"english"
   - 非中文语言下，用户可在简单/困难模式间自由切换
8. 应用记录本地运行日志（包含账户切换、积分变动、配置保存等事件），便于排查问题，可选上传或分享。
9. 在答题页面中，用户可以点击诗歌内容，激活新页面显示（可返回）诗歌的解释、典故、背景知识等，底部有一个对话框，用户可输入问题和LLM服务对话，LLM服务返回内容显示在诗歌解释等内容之后。
 
## 界面要求
首次启动指引：
- 若检测不到激活账户配置，显示引导页，提示用户通过终端运行`poemctl account create <账户名>`创建本地账户
- 引导页提供示例命令、账户文件位置说明以及“刷新账户状态”按钮（重新尝试读取配置）
- 引导页仍展示游戏介绍“猜一猜句子，学唐诗”，并保留背景音乐开关（默认打开）

主界面：
- 诗歌标题和作者
- 诗歌内容，其中一句被外文替代（简单模式--非中文语言首次进入默认简单模式），或星号行（困难模式）
- 4个选项，其中1个是正确答案，3个是类似长度的干扰项
- 当前诗句的配图
- 当前本地账户名、得分、古代学级称号
- 下一首按钮，表示下一首诗，点击后显示下一首诗
- 背景音乐开关按钮，控制背景音乐播放/暂停
- 背景音乐切换按钮，切换到下一首背景音乐
- 注：暂时不使用音效功能，所有音频控制均针对背景音乐
- 底部3个tab，分别导航到主界面、成就和设置界面

特定诗歌的详细信息对话界面：
- 上方大部分显示诗歌的解释、典故、背景知识等，内容可上下滚动
- 底部有一个固定的对话框，用户可输入问题和LLM服务对话，LLM服务返回内容显示在诗歌解释等内容之后
- 对话框上面还可悬浮3个按钮，按钮的内容为诗歌详情结构中的3个动态问题，点击按钮后，对话框输入这个问题，用户可再次编辑或直接点击发送
- 页面显示内容支持Markdown格式渲染，以便比较美观的显示LLM返回内容
- 此页面可从主界面点击当前诗歌进入，有返回按钮返回主界面

设置界面：
- 显示当前激活账户名以及账户文件路径（只读）
- 设置简单/困难模式
  * 中文模式下：用户可在简单/困难模式间自由切换。简单模式下提示语言固定为英文。
- 设置语言（中文、英语、西班牙语、日语、法语、德语）
  * 从其他语言模式切换到中文时，难度模式保持不变。
- 提供“打开终端指引”按钮，点击后显示终端命令速查与注意事项
- 底部3个tab，分别导航到主界面、成就和设置界面

成就界面：
- 显示当前用户得分和古代学级称号
- 展示学级进度和下一等级所需分数
- 等级称号说明和介绍
- 提供最近一次答题时间、累计答题数量等统计信息
- 成就界面不再包含付费流程，所有学习内容在本地无限制开放
- 底部3个tab，分别导航到主界面、成就和设置界面
  
## 技术描述
1. 使用Vue3开发, 使用Vite构建,使用TailwindCSS进行样式管理
2. 使用Capacitor打包成APP
3. 使用Pinia管理状态
4. 使用VueRouter管理路由
5. 使用VueI18n管理国际化，支持中文、英语、西班牙语、日语、法语、德语六种语言。特别地，中文模式下无外语提示，仅支持困难模式
6. 采用本地存储模式：
   - 核心诗歌数据作为静态资源打包在应用中，确保离线状态下可使用全部功能
   - 用户数据（得分、设置等）读取到Pinia状态后，使用Capacitor Filesystem插件写回账户JSON文件，实现跨终端持久化
   - localStorage仅作为运行时缓存，随每次退出应用时刷新为账户JSON中的最新数据
   - JSON文件结构保持向后兼容，提供版本号字段，便于未来迁移
7. 终端账户工具：
   - 使用Node.js开发命令行工具`poemctl`，支持create/remove/list/switch操作
   - `switch`命令写入`~/.chinpoem/active.json`，前端启动时读取该文件，决定当前账户
   - 工具提供`--export`与`--import`选项，方便用户手动备份或迁移账户数据
8. 可观测性与数据分析：
   - 采用本地滚动日志（按日期拆分文件），记录关键操作（账户切换、答题结果、配置保存）
   - 提供“导出日志”按钮，便于用户自助排查
   - 若未来需要接入云分析，可在不依赖自建服务端的情况下直接接入第三方 SDK
9. 多语言架构：
    - 统一语言设置：界面语言与诗歌提示语言使用同一个语言选择器，无需分离
    - 默认界面语言根据用户浏览器/设备语言自动检测
    - 特殊处理中文模式：简单模式下使用英文作为提示语言。
    - 困难模式下保持界面语言设置，但诗歌提示显示为星号
    - 所有UI文本、提示信息、错误信息等均支持六种语言本地化

## 资源描述
1. public/resource/data/ 文件夹中内置了唐诗约300首，以不同语言存放在不同JSON文件中，文件名称为poem_chinese.json, poem_english.json, poem_french.json, poem_german.json, poem_japanese.json, poem_spanish.json，这些文件结构相同。
   - 中文模式：仅使用poem_chinese.json，因为中文模式无外语提示
   - 其他语言模式：以poem_chinese.json为主体内容，对应语言的JSON文件提供翻译提示
2. public/resource/poem_images/ 文件夹中内置了唐诗约300首唐诗的配图，配图名字对应JSON中的id
3. public/resource/sound/ 文件夹中内置了游戏音效（暂时不使用）
4. public/backgroundmusic/ 文件夹中内置了游戏背景音乐，可随机播放
5. public/resource/data/ 文件夹中内置了唐诗的详细信息，包括解释、典故、背景知识、问题等，以JSON格式存储，文件名称为poem_detail_chinese.json, poem_detail_english.json, poem_detail_french.json, poem_detail_german.json, poem_detail_japanese.json, poem_detail_spanish.json，这些文件结构相同。
6. 本地账户目录：默认创建`~/.chinpoem/`，其中`active.json`记录当前账户名，`accounts/<account>.json`存储单个账户的设置和进度，文件内容需支持人类可读与手动编辑。
### LLM DeepSeek API配置
API_KEY = "sk-958bd92ae81d48b286cc6121886385b5"
BASE_URL = "https://api.deepseek.com"
model = 'deepseek-chat'
初始prompt要求：role作为诗歌及历史学家，content使用诗歌内容、解释、典故、背景知识。后续prompt内容要求衔接上一次对话内容，并根据上下文长度适当压缩历史对话内容。

## 数据结构
1. 用户数据（本地存储）
   - `active.json`示例：
     ```json
     {
       "currentAccount": "laotang",
       "lastSwitch": "2024-05-12T10:03:17+08:00",
       "schemaVersion": 1
     }
     ```
   - `accounts/<account>.json`示例：
     ```json
     {
       "account": "laotang",
       "score": 28,
       "rank": "秀才",
       "language": "zh-CN",
       "difficulty": "hard",
       "totalQuestions": 112,
       "correctQuestions": 87,
       "lastPlayedAt": "2024-05-12T10:00:01+08:00",
       "preferences": {
         "musicEnabled": true,
         "musicTrack": "bgm-001.mp3"
       },
       "schemaVersion": 1
     }
     ```
   - 语言设置同时控制界面语言和诗歌提示语言
   - 中文模式下，简单模式的提示语言字段存储为"english"，困难模式的提示语言字段存储为"none"
2. 诗歌资源JSON格式例子：
    {
        "id": "927908c0-999f-4d3f-8192-d67d28f93576",
        "title": "八阵图",
        "author": "杜甫",
        "sentence": [
            {
                "senid": 0,
                "content": "功盖三分国"
            },
            {
                "senid": 1,
                "content": "名高八阵图"
            },
            {
                "senid": 2,
                "content": "江流石不转"
            },
            {
                "senid": 3,
                "content": "遗恨失吞吴"
            }
        ]
    }
3. 古代学级称号对应得分：
-白丁：0-10分  
-学童：11-25分  
-秀才：26-45分  
-廪生：46-70分  
-贡生：71-100分  
-举人：101-135分  
-贡士：136-175分  
-进士：176-220分  
-探花：221-280分  
-榜眼：281-340分  
-状元：341分以上

## 技术实现要点

### 终端账户工具
- 使用Node.js + Commander.js实现`poemctl`命令行工具，封装在`package.json`脚本中，方便跨平台调用
- 支持create/remove/list/switch/inspect/export/import等子命令，所有操作均针对`~/.chinpoem`目录
- 操作完成后将结果以表格或JSON形式输出，错误时返回非零退出码，便于脚本化集成

### 本地持久化同步
- 前端启动时读取`active.json`获取当前账户，若不存在则触发引导流程
- Pinia状态变更后，通过节流策略批量写入账户JSON，避免频繁I/O
- 提供数据校验：检测必填字段缺失或JSON格式错误时，回滚到最近一次有效备份，并提示用户修复
- 允许用户在设置页触发“立即保存”以手动写盘

### 多语言实现
- Vue I18n管理界面国际化，支持6种语言（中文、英语、西班牙语、日语、法语、德语）
- 统一语言设置：界面语言与诗歌提示语言使用同一个语言选择器
- 中文特殊逻辑：
  * 中文模式下游戏逻辑：困难模式下，某一句用星号替代；简单模式下，某一句用英文替代。用户均在四个中文选项中选择正确原句。
- 自动检测用户设备语言作为默认值，检测到中文浏览器时默认进入中文模式+简单模式
- 语言切换时系统自动处理模式切换，无需额外提示
